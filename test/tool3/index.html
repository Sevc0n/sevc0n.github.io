<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calcolatore Cacciatore - Sevcon Tools</title>
  <link rel="icon" type="image/png" href="../../logo.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      padding: 20px;
      color: #ffffff;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(15px);
      border-radius: 25px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.6);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    header {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      padding: 35px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #ff6b6b, #ffd93d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
      font-weight: 300;
    }

    .version-badge {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.5);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.75rem;
      color: #10b981;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    main {
      padding: 40px;
    }

    .calculator-section {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 20px;
      padding: 35px;
      margin-bottom: 35px;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
    }

    .calculator-section h2 {
      color: #10b981;
      margin-bottom: 20px;
      font-size: 1.8rem;
      font-weight: 700;
      text-align: center;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin: 30px 0;
    }

    .form-group {
      background: rgba(50, 130, 184, 0.1);
      border: 1px solid rgba(50, 130, 184, 0.3);
      border-radius: 15px;
      padding: 25px;
    }

    .form-group h3 {
      color: #3282b8;
      margin-bottom: 15px;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      color: #bbe1fa;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .input-group input, .input-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #3282b8;
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 3px rgba(50, 130, 184, 0.2);
    }

    .input-group input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .calculate-button {
      background: linear-gradient(135deg, #3282b8, #0f4c75);
      border: none;
      color: white;
      padding: 18px 40px;
      border-radius: 12px;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 20px auto;
      display: block;
      box-shadow: 0 6px 20px rgba(50, 130, 184, 0.4);
    }

    .calculate-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(50, 130, 184, 0.6);
    }

    .results-section {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 20px;
      padding: 30px;
      margin: 30px 0;
      text-align: center;
    }

    .results-section h3 {
      color: #10b981;
      margin-bottom: 20px;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .result-card {
      background: rgba(50, 130, 184, 0.1);
      border: 1px solid rgba(50, 130, 184, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .result-value {
      font-size: 2rem;
      font-weight: 700;
      color: #3282b8;
      margin-bottom: 5px;
    }

    .result-label {
      color: #bbe1fa;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .profit-positive {
      color: #10b981 !important;
    }

    .profit-negative {
      color: #ef4444 !important;
    }


    .back-link {
      display: inline-block;
      padding: 15px 30px;
      background: rgba(50, 130, 184, 0.1);
      border: 1px solid rgba(50, 130, 184, 0.3);
      color: #3282b8;
      text-decoration: none;
      border-radius: 12px;
      transition: all 0.3s ease;
      font-weight: 600;
      margin: 5px;
    }

    .back-link:hover {
      background: rgba(50, 130, 184, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(50, 130, 184, 0.3);
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(15px);
      margin: 10% auto;
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.6);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: #fff;
    }

    .pozione-card {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pozione-info {
      flex: 1;
    }

    .pozione-info h4 {
      color: #8b5cf6;
      margin: 0 0 5px 0;
      font-size: 1.1rem;
    }

    .pozione-details {
      color: #a0aec0;
      font-size: 0.9rem;
    }

    .pozione-actions {
      display: flex;
      gap: 10px;
    }

    .btn-remove {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
      color: #ef4444;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .btn-remove:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    .guadagno-card {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .guadagno-info {
      flex: 1;
    }

    .guadagno-info h4 {
      color: #10b981;
      margin: 0 0 5px 0;
      font-size: 1.1rem;
    }

    .guadagno-details {
      color: #a0aec0;
      font-size: 0.9rem;
    }

    .summary-compact {
      background: rgba(45, 55, 72, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      font-size: 0.9rem;
    }

    .summary-compact .date {
      color: #10b981;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .summary-compact .details {
      color: #a0aec0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }

    .summary-compact .positive {
      color: #10b981;
    }

    .summary-compact .negative {
      color: #ef4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="version-badge">
        üèπ v1.0.0<br>
        <small>02/10/2025 23:44</small>
      </div>
      <h1>Calcolatore Cacciatore</h1>
      <p class="subtitle">Calcola guadagni e perdite delle tue spedizioni negli abissi</p>
    </header>

    <main>
      <div class="calculator-section">
        <h2>üí∞ Sezione Guadagno</h2>
        <p style="color: #d1d5db; text-align: center; margin-bottom: 30px; font-size: 1.05rem;">
          Inserisci il guadagno del giorno. Se hai fatto la sfida, seleziona la fase raggiunta per calcolare i bronzini (br) ottenuti.
        </p>

        <div style="text-align: center; margin-bottom: 20px;">
          <button class="calculate-button" onclick="apriFinestraGuadagno()" style="background: linear-gradient(135deg, #10b981, #059669);">‚ûï Aggiungi Guadagno</button>
          <button class="calculate-button" onclick="segnaGiornoVuoto()" style="background: linear-gradient(135deg, #6b7280, #4b5563); margin-left: 10px;">üìÖ Giorno Vuoto</button>
        </div>
        <div id="listaGuadagni" style="display: grid; gap: 15px; margin-bottom: 20px;"></div>

        <div class="form-group">
          <h3>üèÅ Sfida</h3>
          <div class="input-group" style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="fattaSfida" style="width: 20px; height: 20px;">
            <label for="fattaSfida" style="margin: 0;">Hai fatto la sfida?</label>
          </div>

          <div id="faseContainer" style="display: none; margin-top: 10px;">
            <div class="input-group">
              <label for="faseSfida">Fase raggiunta:</label>
              <select id="faseSfida">
                <option value="1">Fase 1 (13 br)</option>
                <option value="2">Fase 2 (13 + 18 = 31 br)</option>
                <option value="3">Fase 3 (31 + 18 = 49 br)</option>
                <option value="4">Fase 4 (49 + 23 = 72 br)</option>
              </select>
            </div>
          </div>
        </div>
        </div>

        <button class="calculate-button" onclick="calcolaGuadagno()">üßÆ Calcola Guadagno</button>

        <div class="results-section" id="resultsGuadagno" style="display: none;">
          <h3>üìä Risultati Guadagno</h3>
          <div class="results-grid">
            <div class="result-card">
              <div class="result-value" id="valoreGuadagno">0</div>
              <div class="result-label">Guadagno del Giorno</div>
            </div>
            <div class="result-card">
              <div class="result-value" id="bronziniTotali">0 br</div>
              <div class="result-label">Bronzini dalla Sfida</div>
            </div>
            <div class="result-card">
              <div class="result-value" id="guadagnoTotale">0 br</div>
              <div class="result-label">Guadagno Totale</div>
            </div>
          </div>
        </div>
      </div>

      <div class="calculator-section">
        <h2>üõ°Ô∏è Sezione Costi</h2>
        <p style="color: #d1d5db; text-align: center; margin-bottom: 30px; font-size: 1.05rem;">
          Inserisci i dati dei consumi e delle riparazioni. I calcoli verranno applicati nel prossimo step.
        </p>

        <div class="form-grid">
          <div class="form-group">
            <h3>üõ°Ô∏è Armatura (durabilit√† pezzi)</h3>
            <div class="input-group">
              <label for="elmoDur">Elmo - durabilit√† finale (0-240):</label>
              <input type="number" id="elmoDur" placeholder="Es: 210" min="0" max="240" step="1">
            </div>
            <div class="input-group">
              <label for="torsoDur">Torso - durabilit√† finale (0-240):</label>
              <input type="number" id="torsoDur" placeholder="Es: 180" min="0" max="240" step="1">
            </div>
            <div class="input-group">
              <label for="gambeDur">Gambe - durabilit√† finale (0-240):</label>
              <input type="number" id="gambeDur" placeholder="Es: 95" min="0" max="240" step="1">
            </div>
            <div class="input-group">
              <label for="stivaliDur">Stivali - durabilit√† finale (0-240):</label>
              <input type="number" id="stivaliDur" placeholder="Es: 240" min="0" max="240" step="1">
            </div>
            <hr style="border-color: rgba(255,255,255,0.1); margin: 12px 0;">
            <div class="input-group">
              <label for="patchDisponibili">Patch gi√† craftate disponibili:</label>
              <input type="number" id="patchDisponibili" placeholder="Es: 2" min="0" step="1" value="0">
            </div>
          </div>

          <div class="form-group">
            <h3>üó°Ô∏è Armi e Frecce</h3>
            <div class="input-group">
              <label for="arcoDur">Arco - durabilit√† finale (0-240):</label>
              <input type="number" id="arcoDur" placeholder="Es: 170" min="0" max="240" step="1">
            </div>
            <div class="input-group">
              <label for="stilettoDur">Stiletto - durabilit√† finale (0-240):</label>
              <input type="number" id="stilettoDur" placeholder="Es: 120" min="0" max="240" step="1">
            </div>
            <div class="input-group">
              <label for="cotiDisponibili">Coti gi√† craftate disponibili:</label>
              <input type="number" id="cotiDisponibili" placeholder="Es: 1" min="0" step="1" value="0">
            </div>
            <hr style="border-color: rgba(255,255,255,0.1); margin: 12px 0;">
            <div class="input-group">
              <label for="frecceRimanenti">Frecce rimanenti a fine giornata:</label>
              <input type="number" id="frecceRimanenti" placeholder="Es: 30" min="0" step="1">
            </div>
            <div class="input-group">
              <label>üéØ Target Frecce:</label>
              <div style="color:#a0aec0;">Mantieni sempre 150 frecce disponibili</div>
            </div>
          </div>

          <div class="form-group">
            <h3>üß™ Pozioni</h3>
            <div style="text-align: center; margin-bottom: 20px;">
              <button class="calculate-button" onclick="apriFinestraPozione()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">‚ûï Aggiungi Pozione</button>
            </div>
            <div id="listaPozioni" style="display: grid; gap: 15px;"></div>
          </div>

          <div class="form-group">
            <h3>üçΩÔ∏è Costi Fissi</h3>
            <div class="input-group">
              <label for="costoCalice">Costo Calice Giornaliero (br):</label>
              <input type="number" id="costoCalice" placeholder="Default 3" min="0" step="0.01" value="3">
            </div>
            <div class="input-group">
              <label for="costoCibo">Costo Cibo (br):</label>
              <input type="number" id="costoCibo" placeholder="Es: 15.50" min="0" step="0.01" value="0">
            </div>
          </div>

          <div class="form-group">
            <h3>üè∑Ô∏è Prezzi materie prime</h3>
            <div class="input-group">
              <label for="costoLingotto">Costo 1x Lingotto di Rame (br):</label>
              <input type="number" id="costoLingotto" placeholder="Default 21" min="0" step="0.1" value="21">
            </div>
            <div class="input-group">
              <label for="costoWool">Costo 1x Woolen Fabric (br):</label>
              <input type="number" id="costoWool" placeholder="Default 1.5" min="0" step="0.1" value="1.5">
            </div>
            <div class="input-group">
              <label for="costoHilt">Costo 1x Hilt (br) per coti:</label>
              <input type="number" id="costoHilt" placeholder="Es: 2.0" min="0" step="0.1" value="2.0">
            </div>
            <div class="input-group">
              <label for="costoStick">Costo 1x Stick (br):</label>
              <input type="number" id="costoStick" placeholder="Es: 0.2" min="0" step="0.01" value="0.2">
            </div>
            <div class="input-group">
              <label for="costoPiuma">Costo 1x Piuma (br):</label>
              <input type="number" id="costoPiuma" placeholder="Es: 0.5" min="0" step="0.01" value="0.5">
            </div>
            <div class="input-group">
              <label>üìã Ricette Crafting:</label>
              <div style="color:#a0aec0; line-height: 1.6;">
                <div><strong>Patch:</strong> 1 lingotto + 1 woolen fabric ‚áí 4 patch</div>
                <div><strong>Coti:</strong> 1 hilt + 1 lingotto ‚áí 4 coti</div>
                <div><strong>Frecce:</strong> 1 nugget + 1 stick + 1 piuma ‚áí 20 frecce</div>
                <div><strong>Nugget:</strong> 1 lingotto ‚áí 9 nugget</div>
              </div>
            </div>
          </div>
        </div>

        <button class="calculate-button" onclick="calcolaCostiTotali()">üßÆ Calcola Costi</button>

        <div class="results-section" id="risultatiCostiCompatti" style="display:none;">
          <h3>üìä Riepilogo Costi</h3>
          <div class="results-grid">
            <div class="result-card"><div class="result-value" id="costoArmatura">0 br</div><div class="result-label">üõ°Ô∏è Armatura</div></div>
            <div class="result-card"><div class="result-value" id="costoArmi">0 br</div><div class="result-label">üó°Ô∏è Armi</div></div>
            <div class="result-card"><div class="result-value" id="costoFrecce">0 br</div><div class="result-label">üèπ Frecce</div></div>
            <div class="result-card"><div class="result-value" id="costoPozioni">0 br</div><div class="result-label">üß™ Pozioni</div></div>
            <div class="result-card"><div class="result-value" id="costoCalice">0 br</div><div class="result-label">üçΩÔ∏è Calice</div></div>
            <div class="result-card"><div class="result-value" id="costoCibo">0 br</div><div class="result-label">üçΩÔ∏è Cibo</div></div>
          </div>
        </div>

        <div class="results-section" id="risultatiCostiTotali" style="display:none;">
          <h3>üíµ Totale Costi</h3>
          <div class="results-grid">
            <div class="result-card"><div class="result-value" id="costoTotaleGiorno">0 br</div><div class="result-label">Somma costi (armatura + armi + frecce + pozioni + calice + cibo)</div></div>
          </div>
        </div>
      </div>

      <div class="calculator-section">
        <h2>üìä Rapporto Guadagno/Costi</h2>
        <p style="color: #d1d5db; text-align: center; margin-bottom: 30px; font-size: 1.05rem;">
          Calcola il rapporto tra guadagni e costi per vedere se sei in positivo o negativo.
        </p>
        
        <button class="calculate-button" onclick="calcolaRapporto()" style="background: linear-gradient(135deg, #10b981, #059669);">‚öñÔ∏è Calcola Rapporto</button>

        <div class="results-section" id="risultatiRapporto" style="display:none;">
          <h3>üìà Risultati Rapporto</h3>
          <div class="results-grid">
            <div class="result-card"><div class="result-value" id="rapportoGuadagno">0 br</div><div class="result-label">üí∞ Guadagno Totale</div></div>
            <div class="result-card"><div class="result-value" id="rapportoCosti">0 br</div><div class="result-label">üí∏ Costi Totali</div></div>
            <div class="result-card"><div class="result-value" id="rapportoValore">0:1</div><div class="result-label">üìä Rapporto</div></div>
            <div class="result-card"><div class="result-value" id="rapportoTotale">0 br</div><div class="result-label">‚öñÔ∏è Bilancio</div></div>
          </div>
        </div>
      </div>


      

      <div style="text-align: center; margin-top: 40px;">
        <a href="../../accesso-test.html" class="back-link">üîô Torna all'Accesso</a>
        <a href="../../index.html" class="back-link">üè† Homepage</a>
        <a href="../tool1/index.html" class="back-link">üîß Tool 1</a>
        <a href="../tool2/index.html" class="back-link">üî¨ Tool 2</a>
      </div>

      <div class="calculator-section" id="riepilogoGenerale" style="margin-top: 25px;">
        <h2>üßæ Riepilogo</h2>
        <div style="text-align: center; margin-bottom: 20px;">
          <button class="calculate-button" onclick="salvaGiornataCompleta()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">üíæ Salva Giornata Completa</button>
          <button class="calculate-button" onclick="esportaExcelManuale()" style="background: linear-gradient(135deg, #059669, #047857); margin-left: 10px;">üìä Esporta Excel</button>
        </div>
        <div id="riepilogoGiorni" class="results-grid"></div>
        <div id="riepilogoSettimane" class="results-grid" style="margin-top: 20px;"></div>
      </div>
    </main>
  </div>

  <!-- Modal per aggiungere pozioni -->
  <div id="modalPozione" class="modal">
    <div class="modal-content">
      <span class="close" onclick="chiudiFinestraPozione()">&times;</span>
      <h3 style="color: #8b5cf6; margin-bottom: 20px; text-align: center;">üß™ Aggiungi Pozione</h3>
      
      <div class="input-group">
        <label for="tipoPozione">Tipo di pozione:</label>
        <input type="text" id="tipoPozione" placeholder="Es: Health Potion, Mana Potion" style="width: 100%; padding: 12px 15px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 1rem;">
      </div>
      
      <div class="input-group">
        <label for="costoSingolaPozione">Costo per singola pozione (br):</label>
        <input type="number" id="costoSingolaPozione" placeholder="Es: 15.00" min="0" step="0.01" style="width: 100%; padding: 12px 15px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 1rem;">
      </div>
      
      <div class="input-group">
        <label for="quantitaPozioni">Quantit√† utilizzate:</label>
        <input type="number" id="quantitaPozioni" placeholder="Es: 6" min="0" step="1" style="width: 100%; padding: 12px 15px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 1rem;">
      </div>
      
      <div style="text-align: center; margin-top: 25px;">
        <button class="calculate-button" onclick="aggiungiPozione()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); margin-right: 10px;">‚úÖ Aggiungi</button>
        <button class="calculate-button" onclick="chiudiFinestraPozione()" style="background: linear-gradient(135deg, #6b7280, #4b5563);">‚ùå Annulla</button>
      </div>
    </div>
  </div>

  <!-- Modal per aggiungere guadagni -->
  <div id="modalGuadagno" class="modal">
    <div class="modal-content">
      <span class="close" onclick="chiudiFinestraGuadagno()">&times;</span>
      <h3 style="color: #10b981; margin-bottom: 20px; text-align: center;">üí∞ Aggiungi Guadagno</h3>
      
      <div class="input-group">
        <label for="causaleGuadagno">Causale del guadagno:</label>
        <input type="text" id="causaleGuadagno" placeholder="Es: Vendita materiali, Missioni, etc." style="width: 100%; padding: 12px 15px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 1rem;">
      </div>
      
      <div class="input-group">
        <label for="importoGuadagno">Importo guadagnato (br):</label>
        <input type="number" id="importoGuadagno" placeholder="Es: 1200" min="0" step="0.01" style="width: 100%; padding: 12px 15px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 1rem;">
      </div>
      
      <div style="text-align: center; margin-top: 25px;">
        <button class="calculate-button" onclick="aggiungiGuadagno()" style="background: linear-gradient(135deg, #10b981, #059669); margin-right: 10px;">‚úÖ Aggiungi</button>
        <button class="calculate-button" onclick="chiudiFinestraGuadagno()" style="background: linear-gradient(135deg, #6b7280, #4b5563);">‚ùå Annulla</button>
      </div>
    </div>
  </div>

  <!-- CDN per Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    function placeholderCalcolaCosti() {
      alert('La sezione costi verr√† completata nel prossimo step con i calcoli dettagliati.');
    }

    function patchesNecessariePerPezzo(durFinale) {
      // Ogni pezzo ha max 240; patch ripara 60. Spreco accettabile: ‚â§ 6 durabilit√†
      const max = 240;
      const deficit = Math.max(0, max - (Number(durFinale) || 0));
      if (deficit <= 6) return 0; // Non patchare se il recupero sprecherebbe fino a 6 punti
      return Math.ceil(deficit / 60);
    }

    function calcolaCostiArmatura() {
      const elmo = parseFloat(document.getElementById('elmoDur').value) || 0;
      const torso = parseFloat(document.getElementById('torsoDur').value) || 0;
      const gambe = parseFloat(document.getElementById('gambeDur').value) || 0;
      const stivali = parseFloat(document.getElementById('stivaliDur').value) || 0;

      const costoLingotto = parseFloat(document.getElementById('costoLingotto').value) || 0;
      const costoWool = parseFloat(document.getElementById('costoWool').value) || 0;

      const pElmo = patchesNecessariePerPezzo(elmo);
      const pTorso = patchesNecessariePerPezzo(torso);
      const pGambe = patchesNecessariePerPezzo(gambe);
      const pStivali = patchesNecessariePerPezzo(stivali);
      const pTot = pElmo + pTorso + pGambe + pStivali;
      const stock = Math.max(0, parseInt(document.getElementById('patchDisponibili').value) || 0);
      const usateDaStock = Math.min(stock, pTot);
      const daCraftare = Math.max(0, pTot - usateDaStock);

      // 1 craft = 1 lingotto + 1 woolen = 4 patch
      const craft = Math.ceil(daCraftare / 4);
      const costoTot = craft * (costoLingotto + costoWool);

      document.getElementById('patchElmo').textContent = pElmo;
      document.getElementById('patchTorso').textContent = pTorso;
      document.getElementById('patchGambe').textContent = pGambe;
      document.getElementById('patchStivali').textContent = pStivali;
      document.getElementById('patchTotali').textContent = pTot;
      document.getElementById('patchDaStock').textContent = usateDaStock;
      document.getElementById('patchDaCraftare').textContent = daCraftare;
      document.getElementById('craftNecessari').textContent = craft;
      document.getElementById('costoTotalePatch').textContent = `${costoTot.toFixed(1)} br`;
      const rim = stock - usateDaStock + (craft * 4 - daCraftare);
      document.getElementById('patchRimanenti').textContent = Math.max(0, rim);
      window.__stockPartial = window.__stockPartial || {};
      window.__stockPartial.patch = Math.max(0, rim);

      // Non mostrare pi√π i dettagli, solo i risultati compatti
    }

    function calcolaCostiArmiEFrecce() {
      // Coti per armi (stessa logica patch: 60 dur per coti, spreco ‚â§6)
      const arcoDur = parseFloat(document.getElementById('arcoDur').value) || 0;
      const stilettoDur = parseFloat(document.getElementById('stilettoDur').value) || 0;
      const costoLingotto = parseFloat(document.getElementById('costoLingotto').value) || 0;
      const costoHilt = parseFloat(document.getElementById('costoHilt').value) || 0;

      const cArco = patchesNecessariePerPezzo(arcoDur); // 1 coti ripara 60
      const cStiletto = patchesNecessariePerPezzo(stilettoDur);
      const cTot = cArco + cStiletto;
      const cotiStock = Math.max(0, parseInt(document.getElementById('cotiDisponibili').value) || 0);
      const cotiDaStock = Math.min(cotiStock, cTot);
      const cotiDaCraftare = Math.max(0, cTot - cotiDaStock);
      const craftCoti = Math.ceil(cotiDaCraftare / 4); // 1 craft = 1 hilt + 1 lingotto => 4 coti
      const costoCoti = craftCoti * (costoHilt + costoLingotto);

      document.getElementById('cotiArco').textContent = cArco;
      document.getElementById('cotiStiletto').textContent = cStiletto;
      document.getElementById('cotiTotali').textContent = cTot;
      document.getElementById('cotiDaStock').textContent = cotiDaStock;
      document.getElementById('cotiDaCraftare').textContent = cotiDaCraftare;
      document.getElementById('craftCoti').textContent = craftCoti;
      document.getElementById('costoCoti').textContent = `${costoCoti.toFixed(1)} br`;
      document.getElementById('cotiRimanenti').textContent = Math.max(0, cotiStock - cotiDaStock + (craftCoti * 4 - cotiDaCraftare));

      // Frecce: target 150, calcola quante craftare per arrivare al target
      const frecceRimanenti = parseFloat(document.getElementById('frecceRimanenti').value) || 0;
      const targetFrecce = 150;
      
      // Frecce da craftare = target - rimanenti
      const frecceDaCraftare = Math.max(0, targetFrecce - frecceRimanenti);
      
      const costoStick = parseFloat(document.getElementById('costoStick').value) || 0;
      const costoPiuma = parseFloat(document.getElementById('costoPiuma').value) || 0;
      const lotti = Math.ceil(frecceDaCraftare / 20);
      const nuggetNecessari = lotti; // 1 nugget per lotto da 20 frecce
      const lingottiPerNugget = Math.ceil(nuggetNecessari / 9);
      const costoNugget = lingottiPerNugget * costoLingotto; // semplificazione: costo derivato da lingotti
      const costoStickTot = lotti * costoStick;
      const costoPiumaTot = lotti * costoPiuma;
      const costoFrecce = costoNugget + costoStickTot + costoPiumaTot;

      document.getElementById('frecceTarget').textContent = targetFrecce;
      document.getElementById('frecceDaCraftare').textContent = frecceDaCraftare;
      document.getElementById('frecceLotti').textContent = lotti;
      document.getElementById('nuggetIngot').textContent = lingottiPerNugget;
      document.getElementById('costoFrecceMat').textContent = `${costoFrecce.toFixed(1)} br`;
      document.getElementById('frecceFinali').textContent = frecceRimanenti + (lotti * 20);

      // salva rimanenze parziali
      const cotiRim = Math.max(0, cotiStock - cotiDaStock + (craftCoti * 4 - cotiDaCraftare));
      const frecceRim = Math.max(0, frecceRimanenti + (lotti * 20) - targetFrecce); // frecce in eccesso rispetto al target
      window.__stockPartial = window.__stockPartial || {};
      window.__stockPartial.coti = cotiRim;
      window.__stockPartial.frecce = frecceRim;

      // Non mostrare pi√π i dettagli, solo i risultati compatti
    }

    function calcolaCostiTotali() {
      // Esegue entrambi i calcoli e somma i risultati
      calcolaCostiArmatura();
      calcolaCostiArmiEFrecce();

      // Legge i totali dalle sezioni (ora calcolati direttamente)
      const costoArmatura = calcolaCostoArmatura();
      const costoArmi = calcolaCostoArmi();
      const costoFrecce = calcolaCostoFrecce();
      const costoPozioni = calcolaCostoTotalePozioni();
      const costiFissi = calcolaCostiFissi();
      const costoCalice = parseFloat(document.getElementById('costoCalice').value) || 0;
      const costoCibo = parseFloat(document.getElementById('costoCibo').value) || 0;
      const totale = costoArmatura + costoArmi + costoFrecce + costoPozioni + costiFissi;

      // Aggiorna risultati compatti
      document.getElementById('costoArmatura').textContent = `${costoArmatura.toFixed(1)} br`;
      document.getElementById('costoArmi').textContent = `${costoArmi.toFixed(1)} br`;
      document.getElementById('costoFrecce').textContent = `${costoFrecce.toFixed(1)} br`;
      document.getElementById('costoPozioni').textContent = `${costoPozioni.toFixed(1)} br`;
      document.getElementById('costoCalice').textContent = `${costoCalice.toFixed(1)} br`;
      document.getElementById('costoCibo').textContent = `${costoCibo.toFixed(1)} br`;
      
      document.getElementById('costoTotaleGiorno').textContent = `${totale.toFixed(1)} br`;
      const res = document.getElementById('risultatiCostiCompatti');
      res.style.display = 'block';
      const resTot = document.getElementById('risultatiCostiTotali');
      resTot.style.display = 'block';

      // salva stock rimanente
      const stock = window.__stockPartial || {};
      const toSave = {
        patch: Number(stock.patch || 0),
        coti: Number(stock.coti || 0),
        frecce: Number(stock.frecce || 0)
      };
      setCookie(STORAGE_KEY_STOCK, JSON.stringify(toSave), 365);
    }

    function calcolaCostoArmatura() {
      const elmo = parseFloat(document.getElementById('elmoDur').value) || 0;
      const torso = parseFloat(document.getElementById('torsoDur').value) || 0;
      const gambe = parseFloat(document.getElementById('gambeDur').value) || 0;
      const stivali = parseFloat(document.getElementById('stivaliDur').value) || 0;

      const costoLingotto = parseFloat(document.getElementById('costoLingotto').value) || 0;
      const costoWool = parseFloat(document.getElementById('costoWool').value) || 0;

      const pElmo = patchesNecessariePerPezzo(elmo);
      const pTorso = patchesNecessariePerPezzo(torso);
      const pGambe = patchesNecessariePerPezzo(gambe);
      const pStivali = patchesNecessariePerPezzo(stivali);
      const pTot = pElmo + pTorso + pGambe + pStivali;
      const stock = Math.max(0, parseInt(document.getElementById('patchDisponibili').value) || 0);
      const usateDaStock = Math.min(stock, pTot);
      const daCraftare = Math.max(0, pTot - usateDaStock);

      // 1 craft = 1 lingotto + 1 woolen = 4 patch
      const craft = Math.ceil(daCraftare / 4);
      return craft * (costoLingotto + costoWool);
    }

    function calcolaCostoArmi() {
      const arcoDur = parseFloat(document.getElementById('arcoDur').value) || 0;
      const stilettoDur = parseFloat(document.getElementById('stilettoDur').value) || 0;
      const costoLingotto = parseFloat(document.getElementById('costoLingotto').value) || 0;
      const costoHilt = parseFloat(document.getElementById('costoHilt').value) || 0;

      const cArco = patchesNecessariePerPezzo(arcoDur);
      const cStiletto = patchesNecessariePerPezzo(stilettoDur);
      const cTot = cArco + cStiletto;
      const cotiStock = Math.max(0, parseInt(document.getElementById('cotiDisponibili').value) || 0);
      const cotiDaStock = Math.min(cotiStock, cTot);
      const cotiDaCraftare = Math.max(0, cTot - cotiDaStock);
      const craftCoti = Math.ceil(cotiDaCraftare / 4);
      return craftCoti * (costoHilt + costoLingotto);
    }

    function calcolaCostoFrecce() {
      const frecceRimanenti = parseFloat(document.getElementById('frecceRimanenti').value) || 0;
      const targetFrecce = 150;
      const frecceDaCraftare = Math.max(0, targetFrecce - frecceRimanenti);
      
      const costoLingotto = parseFloat(document.getElementById('costoLingotto').value) || 0;
      const costoStick = parseFloat(document.getElementById('costoStick').value) || 0;
      const costoPiuma = parseFloat(document.getElementById('costoPiuma').value) || 0;
      
      const lotti = Math.ceil(frecceDaCraftare / 20);
      const nuggetNecessari = lotti;
      const lingottiPerNugget = Math.ceil(nuggetNecessari / 9);
      const costoNugget = lingottiPerNugget * costoLingotto;
      const costoStickTot = lotti * costoStick;
      const costoPiumaTot = lotti * costoPiuma;
      return costoNugget + costoStickTot + costoPiumaTot;
    }
    const STORAGE_KEY_GUADAGNO = 'hunter_calc_guadagno_v1';
    const STORAGE_KEY_STOCK = 'hunter_calc_stock_v1';
    const STORAGE_KEY_POZIONI = 'hunter_calc_pozioni_v1';
    const STORAGE_KEY_GUADAGNI_GIORNO = 'hunter_calc_guadagni_giorno_v1';
    const BR_LABEL = ' br';
    
    let pozioniLista = [];
    let guadagniLista = [];

    function toggleFaseVisibility() {
      const fattaSfida = document.getElementById('fattaSfida').checked;
      const faseContainer = document.getElementById('faseContainer');
      faseContainer.style.display = fattaSfida ? 'block' : 'none';
    }

    function calcolaBronziniPerFase(fase) {
      // cumulativo: F1=13, F2=31, F3=49, F4=72
      switch (Number(fase)) {
        case 1: return 13;
        case 2: return 31;
        case 3: return 49;
        case 4: return 72;
        default: return 0;
      }
    }

    function calcolaGuadagno() {
      // Calcola guadagni dalle card dinamiche
      const guadagniTotali = guadagniLista.reduce((totale, guadagno) => totale + guadagno.importo, 0);
      
      // Calcola bronzini dalla sfida
      const fattaSfida = document.getElementById('fattaSfida').checked;
      const fase = fattaSfida ? document.getElementById('faseSfida').value : 0;
      const bronzini = fattaSfida ? calcolaBronziniPerFase(fase) : 0;
      const totale = guadagniTotali + bronzini;

      document.getElementById('valoreGuadagno').textContent = guadagniTotali.toFixed(2);
      document.getElementById('bronziniTotali').textContent = bronzini + ' br';
      document.getElementById('guadagnoTotale').textContent = totale.toFixed(2) + ' br';
      document.getElementById('resultsGuadagno').style.display = 'block';
      document.getElementById('resultsGuadagno').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function salvaGiornataCompleta() {
      // Calcola guadagni totali dalle card dinamiche
      const guadagniTotali = guadagniLista.reduce((totale, guadagno) => totale + guadagno.importo, 0);
      const causale = guadagniLista.length > 0 ? guadagniLista.map(g => g.causale).join(', ') : 'Nessuna causale';
      
      const fattaSfida = document.getElementById('fattaSfida').checked;
      const fase = fattaSfida ? Number(document.getElementById('faseSfida').value) : 0;
      const bronzini = fattaSfida ? calcolaBronziniPerFase(fase) : 0;

      // Calcola costi totali
      const costoArmatura = calcolaCostoArmatura();
      const costoArmi = calcolaCostoArmi();
      const costoFrecce = calcolaCostoFrecce();
      const costoPozioni = calcolaCostoTotalePozioni();
      const costiFissi = calcolaCostiFissi();
      const costiTotali = costoArmatura + costoArmi + costoFrecce + costoPozioni + costiFissi;

      const guadagnoTotale = guadagniTotali + bronzini;
      const bilancio = guadagnoTotale - costiTotali;
      const rapporto = costiTotali > 0 ? (guadagnoTotale / costiTotali).toFixed(2) : '‚àû';

      const entry = {
        id: Date.now(),
        date: new Date().toISOString(),
        guadagno: guadagniTotali,
        causale,
        fattaSfida,
        fase,
        bronzini,
        costi: costiTotali,
        bilancio: bilancio,
        rapporto: rapporto
      };

      const existing = JSON.parse(getCookie(STORAGE_KEY_GUADAGNO) || '[]');
      existing.push(entry);
      setCookie(STORAGE_KEY_GUADAGNO, JSON.stringify(existing), 365);

      // Controlla se √® il momento di esportare (1 mese di dati)
      controllaEsportazioneMensile(existing);

      renderStoricoGuadagno();
      alert('Giornata completa salvata con successo!');
    }

    function cancellaStoricoGuadagno() {
      if (!confirm('Sei sicuro di voler cancellare lo storico del guadagno?')) return;
      deleteCookie(STORAGE_KEY_GUADAGNO);
      renderStoricoGuadagno();
    }

    function formatDate(d) {
      try {
        const date = new Date(d);
        return date.toLocaleString();
      } catch (_) { return d; }
    }

    function renderStoricoGuadagno() {
      const container = document.getElementById('listaStorico');
      const wrapper = document.getElementById('storicoGuadagno');
      const riepilogoGiorni = document.getElementById('riepilogoGiorni');
      const riepilogoSettimane = document.getElementById('riepilogoSettimane');
      if (!container || !wrapper) return;

      const entries = JSON.parse(getCookie(STORAGE_KEY_GUADAGNO) || '[]');
      if (entries.length === 0) {
        wrapper.style.display = 'none';
        container.innerHTML = '';
        if (riepilogoGiorni) riepilogoGiorni.innerHTML = '';
        if (riepilogoSettimane) riepilogoSettimane.innerHTML = '';
        return;
      }

      wrapper.style.display = 'block';
      container.innerHTML = entries
        .sort((a, b) => b.id - a.id)
        .map(e => {
          const labelFase = e.fattaSfida && e.fase ? `Fase ${e.fase}` : 'Nessuna sfida';
          return `
            <div class="feature-card" style="background: rgba(45,55,72,0.5); border:1px solid rgba(255,255,255,0.08);">
              <h3>üóìÔ∏è ${formatDate(e.date)}</h3>
              <ul>
                <li>Guadagno: <strong>${e.guadagno.toFixed(2)} br</strong></li>
                <li>Sfida: <strong>${labelFase}</strong></li>
                <li>Bronzini: <strong>${e.bronzini} br</strong></li>
              </ul>
              <div style="margin-top:10px; display:flex; gap:10px;">
                <button class="back-link" onclick="eliminaEntryGuadagno(${e.id})">Elimina</button>
              </div>
            </div>
          `;
        }).join('');

      // Riepilogo giornaliero compatto
      if (riepilogoGiorni) {
        riepilogoGiorni.innerHTML = entries
          .sort((a, b) => b.id - a.id)
          .map(e => {
            const guadagnoBr = e.guadagno + e.bronzini; // guadagno totale (giornaliero + sfida)
            const costiBr = e.costi || 0; // usa i costi salvati se disponibili
            const totale = e.bilancio !== undefined ? e.bilancio : (guadagnoBr - costiBr);
            const rapporto = e.rapporto || (costiBr > 0 ? (guadagnoBr / costiBr).toFixed(2) : '‚àû');
            const sign = totale >= 0 ? '+' : '-';
            const colore = totale >= 0 ? 'positive' : 'negative';
            return `
              <div class="summary-compact">
                <div class="date">${formatDate(e.date)}</div>
                <div class="details">
                  <div>üí∞ Guadagno: <strong>${guadagnoBr.toFixed(1)}${BR_LABEL}</strong></div>
                  <div>üí∏ Costi: <strong>${costiBr.toFixed(1)}${BR_LABEL}</strong></div>
                  <div>üìä Rapporto: <strong>${rapporto}:1</strong></div>
                  <div>‚öñÔ∏è Bilancio: <strong class="${colore}">${sign}${Math.abs(totale).toFixed(1)}${BR_LABEL}</strong></div>
                </div>
              </div>
            `;
          }).join('');
      }

      // Aggregazione settimanale (ISO week)
      if (riepilogoSettimane) {
        const byWeek = {};
        entries.forEach(e => {
          const d = new Date(e.date);
          const year = d.getFullYear();
          const week = getISOWeekNumber(d);
          const key = `${year}-W${week}`;
          if (!byWeek[key]) byWeek[key] = { dates: [], guadagnoBr: 0, costiBr: 0 };
          byWeek[key].dates.push(d);
          byWeek[key].guadagnoBr += (e.guadagno + e.bronzini);
          byWeek[key].costiBr += (e.costi || 0);
        });

        const cards = Object.entries(byWeek).sort(([a], [b]) => a < b ? 1 : -1).map(([key, val]) => {
          const minDate = new Date(Math.min.apply(null, val.dates));
          const maxDate = new Date(Math.max.apply(null, val.dates));
          const range = `${minDate.toLocaleDateString()} ‚Üí ${maxDate.toLocaleDateString()}`;
          const totale = val.guadagnoBr - val.costiBr;
          const rapporto = val.costiBr > 0 ? (val.guadagnoBr / val.costiBr).toFixed(2) : '‚àû';
          const sign = totale >= 0 ? '+' : '-';
          const colore = totale >= 0 ? 'positive' : 'negative';
          return `
            <div class="summary-compact">
              <div class="date">Settimana ${key} (${range})</div>
              <div class="details">
                <div>üí∞ Guadagno: <strong>${val.guadagnoBr.toFixed(1)}${BR_LABEL}</strong></div>
                <div>üí∏ Costi: <strong>${val.costiBr.toFixed(1)}${BR_LABEL}</strong></div>
                <div>üìä Rapporto: <strong>${rapporto}:1</strong></div>
                <div>‚öñÔ∏è Bilancio: <strong class="${colore}">${sign}${Math.abs(totale).toFixed(1)}${BR_LABEL}</strong></div>
              </div>
            </div>
          `;
        }).join('');

        riepilogoSettimane.innerHTML = cards;
      }
    }

    function eliminaEntryGuadagno(id) {
      const entries = JSON.parse(getCookie(STORAGE_KEY_GUADAGNO) || '[]');
      const filtered = entries.filter(e => e.id !== id);
      setCookie(STORAGE_KEY_GUADAGNO, JSON.stringify(filtered), 365);
      renderStoricoGuadagno();
    }

    // placeholder: la sezione spedizione verr√† reintrodotta in seguito

    // Validazione input in tempo reale
    document.addEventListener('DOMContentLoaded', function() {
      const inputs = document.querySelectorAll('input[type="number"]');
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          if (this.value < 0) {
            this.value = 0;
          }
        });
      });
      // Attiva toggle fase alla prima apertura
      const fattaSfida = document.getElementById('fattaSfida');
      if (fattaSfida) {
        fattaSfida.addEventListener('change', toggleFaseVisibility);
        toggleFaseVisibility();
      }
      // Precompila stock da cookie
      try {
        const savedStock = JSON.parse(getCookie(STORAGE_KEY_STOCK) || '{}');
        if (savedStock && typeof savedStock === 'object') {
          if (typeof savedStock.patch === 'number') document.getElementById('patchDisponibili').value = savedStock.patch;
          if (typeof savedStock.coti === 'number') document.getElementById('cotiDisponibili').value = savedStock.coti;
        }
      } catch (e) {}

      // Carica e renderizza pozioni (solo se non ci sono gi√†)
      if (pozioniLista.length === 0) {
        caricaPozioni();
      }
      renderPozioni();

      // Carica e renderizza guadagni
      caricaGuadagni();
      renderGuadagni();

      // Render iniziale storico
      renderStoricoGuadagno();
    });

    // Animazione di benvenuto
    window.addEventListener('load', () => {
      const cards = document.querySelectorAll('.form-group');
      cards.forEach((card, index) => {
        setTimeout(() => {
          card.style.opacity = '0';
          card.style.transform = 'translateY(20px)';
          card.style.transition = 'all 0.6s ease';
          
          setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          }, 100);
        }, index * 200);
      });
    });

    function getISOWeekNumber(date) {
      const tmp = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = tmp.getUTCDay() || 7;
      tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1)/7);
      return weekNo;
    }

    // Funzioni per gestire le pozioni
    function apriFinestraPozione() {
      document.getElementById('modalPozione').style.display = 'block';
      // Pulisci i campi
      document.getElementById('tipoPozione').value = '';
      document.getElementById('costoSingolaPozione').value = '';
      document.getElementById('quantitaPozioni').value = '';
    }

    function chiudiFinestraPozione() {
      document.getElementById('modalPozione').style.display = 'none';
    }

    function aggiungiPozione() {
      const tipo = document.getElementById('tipoPozione').value.trim();
      const costo = parseFloat(document.getElementById('costoSingolaPozione').value) || 0;
      const quantita = parseInt(document.getElementById('quantitaPozioni').value) || 0;

      if (!tipo) {
        alert('Inserisci il tipo di pozione');
        return;
      }

      if (costo <= 0) {
        alert('Inserisci un costo valido');
        return;
      }

      if (quantita <= 0) {
        alert('Inserisci una quantit√† valida');
        return;
      }

      const pozione = {
        id: Date.now(),
        tipo: tipo,
        costo: costo,
        quantita: quantita,
        totale: costo * quantita
      };

      pozioniLista.push(pozione);
      salvaPozioni();
      renderPozioni();
      chiudiFinestraPozione();
    }

    function rimuoviPozione(id) {
      pozioniLista = pozioniLista.filter(p => p.id !== id);
      salvaPozioni();
      renderPozioni();
    }

    // Funzioni per gestire i cookie persistenti
    function setCookie(name, value, days = 365) {
      const expires = new Date();
      expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/;SameSite=Strict`;
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) {
          return decodeURIComponent(c.substring(nameEQ.length, c.length));
        }
      }
      return null;
    }

    function deleteCookie(name) {
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
    }

    function salvaPozioni() {
      setCookie(STORAGE_KEY_POZIONI, JSON.stringify(pozioniLista), 365);
    }

    function caricaPozioni() {
      const saved = getCookie(STORAGE_KEY_POZIONI);
      if (saved) {
        try {
          pozioniLista = JSON.parse(saved);
        } catch (e) {
          pozioniLista = [];
        }
      } else {
        pozioniLista = [];
      }
    }

    function renderPozioni() {
      const container = document.getElementById('listaPozioni');
      if (!container) return;

      if (pozioniLista.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #a0aec0; padding: 20px;">Nessuna pozione aggiunta</div>';
        return;
      }

      container.innerHTML = pozioniLista.map(pozione => `
        <div class="pozione-card">
          <div class="pozione-info">
            <h4>${pozione.tipo}</h4>
            <div class="pozione-details">
              ${pozione.quantita} √ó ${pozione.costo.toFixed(2)} br = <strong>${pozione.totale.toFixed(2)} br</strong>
            </div>
          </div>
          <div class="pozione-actions">
            <button class="btn-remove" onclick="rimuoviPozione(${pozione.id})">üóëÔ∏è Rimuovi</button>
          </div>
        </div>
      `).join('');
    }

    function calcolaCostoTotalePozioni() {
      return pozioniLista.reduce((totale, pozione) => totale + pozione.totale, 0);
    }

    function calcolaCostiFissi() {
      const costoCalice = parseFloat(document.getElementById('costoCalice').value) || 0;
      const costoCibo = parseFloat(document.getElementById('costoCibo').value) || 0;
      return costoCalice + costoCibo;
    }

    // Funzioni per gestire i guadagni dinamici
    function apriFinestraGuadagno() {
      document.getElementById('modalGuadagno').style.display = 'block';
      // Pulisci i campi
      document.getElementById('causaleGuadagno').value = '';
      document.getElementById('importoGuadagno').value = '';
    }

    function chiudiFinestraGuadagno() {
      document.getElementById('modalGuadagno').style.display = 'none';
    }

    function aggiungiGuadagno() {
      const causale = document.getElementById('causaleGuadagno').value.trim();
      const importo = parseFloat(document.getElementById('importoGuadagno').value) || 0;

      if (!causale) {
        alert('Inserisci la causale del guadagno');
        return;
      }

      if (importo <= 0) {
        alert('Inserisci un importo valido');
        return;
      }

      const guadagno = {
        id: Date.now(),
        causale: causale,
        importo: importo
      };

      guadagniLista.push(guadagno);
      salvaGuadagni();
      renderGuadagni();
      chiudiFinestraGuadagno();
    }

    function rimuoviGuadagno(id) {
      guadagniLista = guadagniLista.filter(g => g.id !== id);
      salvaGuadagni();
      renderGuadagni();
    }

    function salvaGuadagni() {
      setCookie(STORAGE_KEY_GUADAGNI_GIORNO, JSON.stringify(guadagniLista), 365);
    }

    function caricaGuadagni() {
      const saved = getCookie(STORAGE_KEY_GUADAGNI_GIORNO);
      if (saved) {
        try {
          guadagniLista = JSON.parse(saved);
        } catch (e) {
          guadagniLista = [];
        }
      } else {
        guadagniLista = [];
      }
    }

    function renderGuadagni() {
      const container = document.getElementById('listaGuadagni');
      if (!container) return;

      if (guadagniLista.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #a0aec0; padding: 20px;">Nessun guadagno aggiunto</div>';
        return;
      }

      container.innerHTML = guadagniLista.map(guadagno => `
        <div class="guadagno-card">
          <div class="guadagno-info">
            <h4>${guadagno.causale}</h4>
            <div class="guadagno-details">
              <strong>${guadagno.importo.toFixed(2)} br</strong>
            </div>
          </div>
          <div class="pozione-actions">
            <button class="btn-remove" onclick="rimuoviGuadagno(${guadagno.id})">üóëÔ∏è Rimuovi</button>
          </div>
        </div>
      `).join('');
    }

    // Funzioni per esportazione mensile automatica
    function controllaEsportazioneMensile(entries) {
      if (entries.length < 2) return; // Almeno 2 giorni per considerare un mese

      // Ordina per data
      const sortedEntries = entries.sort((a, b) => new Date(a.date) - new Date(b.date));
      const firstDate = new Date(sortedEntries[0].date);
      const lastDate = new Date(sortedEntries[sortedEntries.length - 1].date);
      
      // Calcola differenza in giorni
      const diffTime = Math.abs(lastDate - firstDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      // Se sono passati 30+ giorni, suggerisci esportazione
      if (diffDays >= 30) {
        const shouldExport = confirm(
          `üìä Hai raccolto dati per ${diffDays} giorni!\n\n` +
          `√à il momento di esportare i tuoi rapporti mensili.\n` +
          `Vuoi scaricare un file Excel con tutti i dati?`
        );
        
        if (shouldExport) {
          esportaExcelMensile(sortedEntries);
        }
      }
    }

    function esportaExcelMensile(entries) {
      try {
        // Prepara i dati per Excel
        const excelData = entries.map(entry => {
          const date = new Date(entry.date);
          return {
            'Data': date.toLocaleDateString('it-IT'),
            'Ora': date.toLocaleTimeString('it-IT'),
            'Guadagno Giornaliero (br)': entry.guadagno.toFixed(2),
            'Bronzini Sfida (br)': entry.bronzini,
            'Guadagno Totale (br)': (entry.guadagno + entry.bronzini).toFixed(2),
            'Costi Totali (br)': entry.costi ? entry.costi.toFixed(2) : '0.00',
            'Bilancio (br)': entry.bilancio ? entry.bilancio.toFixed(2) : '0.00',
            'Rapporto': entry.rapporto || '‚àû',
            'Causale': entry.causale || 'Nessuna',
            'Sfida Completata': entry.fattaSfida ? 'S√¨' : 'No',
            'Fase Sfida': entry.fase || 'N/A',
            'Tipo Giorno': entry.causale === 'Giorno vuoto' ? 'Vuoto' : 'Normale'
          };
        });

        // Aggiungi riga di totali
        const totali = {
          'Data': 'TOTALI',
          'Ora': '',
          'Guadagno Giornaliero (br)': entries.reduce((sum, e) => sum + e.guadagno, 0).toFixed(2),
          'Bronzini Sfida (br)': entries.reduce((sum, e) => sum + e.bronzini, 0),
          'Guadagno Totale (br)': entries.reduce((sum, e) => sum + e.guadagno + e.bronzini, 0).toFixed(2),
          'Costi Totali (br)': entries.reduce((sum, e) => sum + (e.costi || 0), 0).toFixed(2),
          'Bilancio (br)': entries.reduce((sum, e) => sum + (e.bilancio || 0), 0).toFixed(2),
          'Rapporto': 'N/A',
          'Causale': '',
          'Sfida Completata': '',
          'Fase Sfida': '',
          'Tipo Giorno': ''
        };

        excelData.push(totali);

        // Crea workbook Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // Imposta larghezza colonne
        ws['!cols'] = [
          { wch: 12 }, // Data
          { wch: 10 }, // Ora
          { wch: 18 }, // Guadagno Giornaliero
          { wch: 15 }, // Bronzini Sfida
          { wch: 16 }, // Guadagno Totale
          { wch: 15 }, // Costi Totali
          { wch: 12 }, // Bilancio
          { wch: 10 }, // Rapporto
          { wch: 25 }, // Causale
          { wch: 15 }, // Sfida Completata
          { wch: 12 }, // Fase Sfida
          { wch: 12 }  // Tipo Giorno
        ];

        XLSX.utils.book_append_sheet(wb, ws, 'Rapporti Cacciatore');

        // Genera nome file con data
        const now = new Date();
        const fileName = `rapporti_cacciatore_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.xlsx`;

        // Scarica il file
        XLSX.writeFile(wb, fileName);

        alert('üìä File Excel esportato con successo!\n\n' + fileName);
        
      } catch (error) {
        console.error('Errore durante esportazione Excel:', error);
        alert('‚ùå Errore durante l\'esportazione. Riprova pi√π tardi.');
      }
    }

    function esportaExcelManuale() {
      const entries = JSON.parse(getCookie(STORAGE_KEY_GUADAGNO) || '[]');
      if (entries.length === 0) {
        alert('‚ùå Nessun dato da esportare. Salva prima alcune giornate!');
        return;
      }
      
      const sortedEntries = entries.sort((a, b) => new Date(a.date) - new Date(b.date));
      esportaExcelMensile(sortedEntries);
    }

    function segnaGiornoVuoto() {
      const costoCalice = parseFloat(document.getElementById('costoCalice').value) || 3;
      const confirmed = confirm(
        'üìÖ Vuoi segnare questo come un giorno vuoto?\n\n' +
        'Questo salver√† una giornata con:\n' +
        '‚Ä¢ Guadagno: 0 br\n' +
        '‚Ä¢ Costi: ' + costoCalice + ' br (solo calice)\n' +
        '‚Ä¢ Causale: "Giorno vuoto"'
      );
      
      if (!confirmed) return;

      const entry = {
        id: Date.now(),
        date: new Date().toISOString(),
        guadagno: 0,
        causale: 'Giorno vuoto',
        fattaSfida: false,
        fase: 0,
        bronzini: 0,
        costi: costoCalice,
        bilancio: -costoCalice,
        rapporto: '0'
      };

      const existing = JSON.parse(getCookie(STORAGE_KEY_GUADAGNO) || '[]');
      existing.push(entry);
      setCookie(STORAGE_KEY_GUADAGNO, JSON.stringify(existing), 365);

      // Controlla se √® il momento di esportare (1 mese di dati)
      controllaEsportazioneMensile(existing);

      renderStoricoGuadagno();
      alert('üìÖ Giorno vuoto salvato con successo!');
    }

    function calcolaRapporto() {
      // Calcola guadagno totale dalle card dinamiche
      const guadagniTotali = guadagniLista.reduce((totale, guadagno) => totale + guadagno.importo, 0);
      
      const fattaSfida = document.getElementById('fattaSfida').checked;
      const fase = fattaSfida ? document.getElementById('faseSfida').value : 0;
      const bronzini = fattaSfida ? calcolaBronziniPerFase(fase) : 0;
      const guadagnoTotale = guadagniTotali + bronzini;

      // Calcola costi totali
      const costoArmatura = calcolaCostoArmatura();
      const costoArmi = calcolaCostoArmi();
      const costoFrecce = calcolaCostoFrecce();
      const costoPozioni = calcolaCostoTotalePozioni();
      const costiFissi = calcolaCostiFissi();
      const costiTotali = costoArmatura + costoArmi + costoFrecce + costoPozioni + costiFissi;

      // Calcola rapporto e bilancio
      const rapporto = costiTotali > 0 ? (guadagnoTotale / costiTotali).toFixed(2) : '‚àû';
      const bilancio = guadagnoTotale - costiTotali;

      // Aggiorna UI
      document.getElementById('rapportoGuadagno').textContent = `${guadagnoTotale.toFixed(1)} br`;
      document.getElementById('rapportoCosti').textContent = `${costiTotali.toFixed(1)} br`;
      document.getElementById('rapportoValore').textContent = `${rapporto}:1`;
      
      const bilancioElement = document.getElementById('rapportoTotale');
      bilancioElement.textContent = `${bilancio >= 0 ? '+' : ''}${bilancio.toFixed(1)} br`;
      bilancioElement.className = bilancio >= 0 ? 'result-value profit-positive' : 'result-value profit-negative';

      // Mostra risultati
      const res = document.getElementById('risultatiRapporto');
      res.style.display = 'block';
      res.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  </script>
</body>
</html>


