<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Abaco Divisore - TEST</title>
  <link rel="icon" type="image/png" href="../../logo.png">
  <link rel="shortcut icon" type="image/png" href="../../logo.png">
  <link rel="apple-touch-icon" href="../../logo.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      overflow-x: hidden;
      max-width: 100vw;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      padding: 20px;
      color: #ffffff;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(20, 25, 45, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      animation: slideIn 0.6s ease-out;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    header {
      background: linear-gradient(135deg, #2d3748, #4a5568);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
      animation: pulse 4s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.3; }
      50% { transform: scale(1.1); opacity: 0.6; }
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }

    .subtitle {
      font-size: 1.1rem;
      opacity: 0.8;
      position: relative;
      z-index: 1;
    }

    main {
      padding: 40px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    .card {
      background: rgba(45, 55, 72, 0.6);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
      border-color: rgba(99, 179, 237, 0.3);
    }

    .card h2 {
      color: #ffffff;
      font-size: 1.5rem;
      margin-bottom: 25px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card h2::before {
      content: '';
      width: 4px;
      height: 25px;
      background: linear-gradient(135deg, #63b3ed, #4299e1);
      border-radius: 2px;
    }

    .category-section {
      margin-bottom: 30px;
      overflow: hidden;
    }

    .category-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #63b3ed;
      margin-bottom: 15px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(99, 179, 237, 0.3);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .subcategoryDiv {
      margin-bottom: 20px;
      overflow: hidden;
    }

    .subcategoryTitle {
      font-size: 1rem;
      color: #a0aec0;
      margin-bottom: 10px;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .product {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 12px 0;
      padding: 15px;
      background: rgba(99, 179, 237, 0.05);
      border-radius: 10px;
      transition: all 0.3s ease;
      border: 1px solid rgba(99, 179, 237, 0.1);
      overflow: hidden;
    }

    .product:hover {
      background: rgba(99, 179, 237, 0.1);
      transform: translateX(5px);
      border-color: rgba(99, 179, 237, 0.3);
    }

    .product-info {
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }

    .product-name {
      font-weight: 500;
      color: #ffffff;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .product-price {
      font-weight: 600;
      color: #68d391;
      font-size: 0.9rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .tier-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 8px;
    }

    .tier-novizio { background: #a0aec0; color: #2d3748; }
    .tier-avanzato { background: #ed8936; color: white; }
    .tier-esperto { background: #718096; color: white; }
    .tier-custode { background: #d69e2e; color: white; }
    .tier-maestro { background: #4299e1; color: white; }
    .tier-tutti { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }

    .quantity-container {
      display: flex;
      align-items: center;
      gap: 5px;
      flex-shrink: 0;
    }

    .quantity-btn {
      width: 30px;
      height: 30px;
      border: 2px solid #63b3ed;
      background: rgba(45, 55, 72, 0.8);
      color: #63b3ed;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
      transition: all 0.2s ease;
    }

    .quantity-btn:hover {
      background: #63b3ed;
      color: white;
    }

    .quantity-btn:active {
      transform: scale(0.95);
    }

    .quantity-input {
      width: 60px;
      padding: 5px;
      text-align: center;
      border: 2px solid rgba(99, 179, 237, 0.3);
      border-radius: 6px;
      font-size: 14px;
      background: rgba(45, 55, 72, 0.8);
      color: #ffffff;
      -moz-appearance: textfield;
    }

    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .quantity-input:focus {
      outline: none;
      border-color: #63b3ed;
      box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.2);
    }

    .product input, #participants {
      padding: 12px;
      border: 2px solid rgba(99, 179, 237, 0.3);
      border-radius: 8px;
      font-size: 1rem;
      text-align: center;
      transition: all 0.3s ease;
      background: rgba(45, 55, 72, 0.8);
      color: #ffffff;
      -moz-appearance: textfield;
      overflow: hidden;
    }

    .product input::-webkit-outer-spin-button,
    .product input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .product input:focus, #participants:focus {
      outline: none;
      border-color: #63b3ed;
      box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.2);
      transform: scale(1.02);
    }

    .participants-section {
      text-align: center;
    }

    .participants-label {
      display: block;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    #participants {
      width: 120px;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .participant-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .participant-label {
      font-weight: bold;
      color: #ffffff;
      min-width: 100px;
    }

    .class-select {
      padding: 8px 12px;
      border: 2px solid rgba(99, 179, 237, 0.3);
      border-radius: 8px;
      font-size: 14px;
      background: rgba(45, 55, 72, 0.8);
      color: #ffffff;
      min-width: 100px;
    }

    .class-select:focus {
      outline: none;
      border-color: #63b3ed;
      box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.2);
    }

    .division-method-btn {
      padding: 10px 20px;
      border: 2px solid rgba(99, 179, 237, 0.3);
      border-radius: 8px;
      background: rgba(45, 55, 72, 0.8);
      color: #ffffff;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }

    .division-method-btn:hover {
      background: rgba(99, 179, 237, 0.1);
      border-color: rgba(99, 179, 237, 0.5);
      transform: translateY(-2px);
    }

    .division-method-btn.active {
      background: linear-gradient(135deg, #63b3ed, #4299e1);
      border-color: #63b3ed;
      color: white;
    }

    .division-method-btn.active:hover {
      background: linear-gradient(135deg, #4299e1, #3182ce);
    }

    .advanced-options {
      transition: all 0.3s ease;
    }

    .advanced-options.hidden {
      display: none;
    }


    .priority-info {
      background: rgba(99, 179, 237, 0.1);
      border: 1px solid rgba(99, 179, 237, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      text-align: left;
    }

    .priority-info h4 {
      color: #63b3ed;
      margin-bottom: 10px;
    }

    .priority-list {
      font-size: 0.9rem;
      color: #a0aec0;
    }

    .priority-list ul {
      margin-left: 20px;
    }

    .priority-list li {
      margin-bottom: 5px;
    }

    #calculate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 179, 237, 0.4);
    }

    #calculate-btn:active {
      transform: translateY(0);
    }

    #calculate-btn:disabled {
      background: #a0aec0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .results-card {
      background: linear-gradient(135deg, rgba(72, 187, 120, 0.2), rgba(56, 178, 172, 0.2));
      color: white;
      border: 1px solid rgba(72, 187, 120, 0.3);
      max-height: none;
      overflow: visible;
    }

    .results-card h2 {
      color: white;
      margin-bottom: 20px;
    }

    .results-card h2::before {
      background: rgba(72, 187, 120, 0.6);
    }

    .participant-result {
      margin: 20px 0;
      padding: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }

    .participant-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: #63b3ed;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .item-distribution {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      margin: 8px 0;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      overflow: hidden;
    }

    .total-cost {
      text-align: center;
      margin-top: 15px;
      padding: 12px;
      background: rgba(72, 187, 120, 0.2);
      border-radius: 8px;
      font-weight: 600;
      border: 1px solid rgba(72, 187, 120, 0.3);
      overflow: hidden;
    }

    .empty-state {
      text-align: center;
      color: #a0aec0;
      font-style: italic;
      padding: 40px;
      overflow: hidden;
    }

    .currency-br {
      color: #68d391;
      font-weight: 600;
    }
    
    .currency-a {
      color: #c0c0c0;
      font-weight: 600;
    }
    
    .currency-mixed {
      color: #68d391;
      font-weight: 600;
    }

    .logo {
      width: 40px;
      height: 40px;
      margin-right: 15px;
      vertical-align: middle;
    }

    .loading {
      text-align: center;
      color: #a0aec0;
      padding: 40px;
      font-style: italic;
      overflow: hidden;
    }

    .error {
      text-align: center;
      color: #f56565;
      padding: 20px;
      background: rgba(245, 101, 101, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(245, 101, 101, 0.3);
      overflow: hidden;
    }

    .warning {
      text-align: center;
      color: #ed8936;
      padding: 20px;
      background: rgba(237, 137, 54, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(237, 137, 54, 0.3);
      overflow: hidden;
    }

    .contacts-section {
      background: rgba(30, 35, 55, 0.8);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px 40px;
      text-align: center;
      margin-top: 30px;
      overflow: hidden;
    }
 
     .contacts-title {
       color: #63b3ed;
       font-size: 1.1rem;
       margin-bottom: 15px;
       font-weight: 600;
     }
 
     .contact-item {
       display: inline-block;
       margin: 0 15px 8px 0;
       padding: 8px 16px;
       background: rgba(99, 179, 237, 0.1);
       border: 1px solid rgba(99, 179, 237, 0.3);
       border-radius: 20px;
       color: #ffffff;
       text-decoration: none;
       transition: all 0.3s ease;
       font-weight: 500;
       font-size: 0.9rem;
       overflow: hidden;
     }
 
     .contact-item:hover {
       background: rgba(99, 179, 237, 0.2);
       border-color: rgba(99, 179, 237, 0.5);
       transform: translateY(-2px);
     }
 
     .contact-item strong {
       color: #63b3ed;
     }
 
    .fractional-display {
      color: #fbb6ce;
      font-size: 0.9em;
      font-style: italic;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .product {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
        text-align: center;
      }
      
      .product-info {
        text-align: center;
      }
      
      .quantity-container {
        justify-content: center;
      }
      
      .participant-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .participant-label {
        min-width: auto;
        text-align: center;
      }
      
      .class-select {
        min-width: auto;
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .container {
        margin: 10px;
        border-radius: 15px;
      }
      
      header {
        padding: 20px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      main {
        padding: 20px;
      }
      
      .card {
        padding: 20px;
      }
    }

    @media (max-width: 360px) {
      body {
        padding: 10px;
      }
      
      .container {
        margin: 0;
        border-radius: 10px;
      }
      
      header {
        padding: 15px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      main {
        padding: 15px;
      }
      
      .card {
        padding: 15px;
      }
      
      .quantity-btn {
        width: 25px;
        height: 25px;
        font-size: 14px;
      }
      
      .quantity-input {
        width: 50px;
        font-size: 12px;
      }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      .quantity-btn {
        width: 35px;
        height: 35px;
        font-size: 18px;
      }
      
      .quantity-input {
        width: 70px;
        font-size: 16px;
        padding: 8px;
      }
      
      .class-select {
        padding: 12px;
        font-size: 16px;
      }
    }

   </style>
 </head>
 <body>
   <div class="container">
           <header>
                 <h1><img src="../../logo.png" alt="Abaco Logo" class="logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">Abaco per Divisione Abisso - TEST</h1>
        <p class="subtitle">Divisore intelligente per bottini di abisso - Test</p>
                 <a href="../../" style="position: absolute; top: 20px; right: 20px; color: #63b3ed; text-decoration: none; font-size: 0.9rem; padding: 8px 12px; border: 1px solid rgba(99, 179, 237, 0.3); border-radius: 8px; transition: all 0.3s ease; cursor: pointer; display: block; width: auto; height: auto; z-index: 10;" onmouseover="this.style.background='rgba(99, 179, 237, 0.1)'" onmouseout="this.style.background='transparent'">üè† Homepage</a>
      </header>
 
     <main>
       <div class="grid">
                   <div class="card">
            <h2>Lista Materiali
              <button id="reload-data" style="float: right; background: rgba(99, 179, 237, 0.2); border: 1px solid rgba(99, 179, 237, 0.5); color: #63b3ed; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem;" onclick="reloadData()">üîÑ Ricarica Dati</button>
            </h2>
            <div id="product-list">
              <div class="loading">Caricamento materiali in corso...</div>
            </div>
          </div>
 
         <div>
           <div class="card participants-section">
             <h2>Partecipanti</h2>
             <label class="participants-label">Numero di partecipanti:</label>
             <input type="number" id="participants" min="1" value="4">
             
             <div style="margin: 20px 0; text-align: center;">
               <label class="participants-label">Metodo di Divisione:</label>
               <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                 <button id="simple-division-btn" class="division-method-btn active" onclick="setDivisionMethod('simple')">
                   üìä Divisione Semplice
                 </button>
                 <button id="advanced-division-btn" class="division-method-btn" onclick="setDivisionMethod('advanced')">
                   ‚öôÔ∏è Divisione Avanzata
                 </button>
               </div>
             </div>
             
             <div class="advanced-options" style="margin: 20px 0; text-align: center;">
               <label class="participants-label">Tier Abisso (imposta per tutti):</label>
               <select id="abyss-tier" style="padding: 8px 12px; border: 2px solid rgba(99, 179, 237, 0.3); border-radius: 8px; font-size: 14px; background: rgba(45, 55, 72, 0.8); color: #ffffff; min-width: 120px; margin-left: 10px;">
                 <option value="">Seleziona Tier</option>
                 <option value="Novizio">Novizio</option>
                 <option value="Avanzato">Avanzato</option>
                 <option value="Esperto">Esperto</option>
                 <option value="Custode">Custode</option>
                 <option value="Maestro">Maestro</option>
               </select>
               <div id="abyss-tier-info" style="margin-top: 10px; font-size: 0.9rem; color: #a0aec0; display: none;">
                 ‚ö° Tier dell'abisso attivo - tutti i partecipanti sono impostati a questo livello (puoi modificare individualmente)
               </div>
             </div>
             
             <div id="participant-classes" class="advanced-options"></div>
             
             <div style="text-align: center; margin: 20px 0;">
               <button id="calculate-btn" style="background: linear-gradient(135deg, #63b3ed, #4299e1); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(99, 179, 237, 0.3);">
                 üßÆ Calcola Divisione
               </button>
             </div>
             
             <div id="simple-legend" class="priority-info">
               <h4>Divisione Semplice (Algoritmo Abaco Principale)</h4>
               <div class="priority-list">
                 <p><strong>Come funziona:</strong></p>
                 <ul>
                   <li>Distribuisce <strong>equamente</strong> gli oggetti interi per tipo</li>
                   <li>Ogni partecipante riceve la <strong>stessa quantit√†</strong> di ogni oggetto</li>
                   <li>L'<strong>esubero</strong> viene distribuito in modo <strong>bilanciato</strong></li>
                   <li>Gli oggetti dell'esubero vanno al partecipante con <strong>valore pi√π basso</strong></li>
                   <li><strong>Nessuna priorit√†</strong> per classi o tier</li>
                   <li>Distribuzione <strong>equa e bilanciata</strong> per valore</li>
                   <li>Usa lo <strong>stesso algoritmo</strong> dell'abaco principale</li>
                 </ul>
                 <p><strong>Esempio:</strong> Con 4 partecipanti e 10 Brim: ogni partecipante riceve 2 Brim (8 totali), poi i 2 rimanenti vanno al partecipante con valore pi√π basso</p>
               </div>
             </div>

             <div id="advanced-legend" class="priority-info advanced-options">
               <h4>Divisione Avanzata (Sistema Stelline e Priorit√†)</h4>
               <div class="priority-list">
                 <p><strong>Classi e Maestranze disponibili:</strong></p>
                 <ul>
                   <li><strong>Guerriero/Ombra:</strong> Bassa priorit√† (prendono l'equivalente)</li>
                   <li><strong>Bardo:</strong> Priorit√† su Stagno</li>
                   <li><strong>Mago:</strong> Priorit√† su Brim, Occhio di ragno, Membrana, Prismarine Shard, Lost Soul</li>
                   <li><strong>Cacciatore:</strong> Priorit√† su Ametista, Membrana, Prismarine Shard</li>
                   <li><strong>Raccoglitore:</strong> Priorit√† su Occhio di ragno, Membrana, Prismarine Shard, Lost Soul</li>
                 </ul>
                 <p><strong>Sistema Stelle per Pozioni:</strong> Ogni reagente ha un valore in stelle per le pozioni di cura. Il sistema bilancia le stelle tra tutti i partecipanti.</p>
                 <p><strong>Valore Stelle:</strong></p>
                 <ul>
                   <li><strong>1‚òÖ:</strong> Brim, Carne marcia, Quarzo, Therium, Occhio di ragno, Ametista</li>
                   <li><strong>2‚òÖ:</strong> Blaze Powder, Membrana, Slime Ball, Prismarine Shard</li>
                   <li><strong>3‚òÖ:</strong> Lost Soul, Demon Heart</li>
                 </ul>
               </div>
             </div>
           </div>
 
           <div class="card results-card">
             <h2>Distribuzione</h2>
             <div id="distribution-results"></div>
           </div>
         </div>
       </div>
     </main>
 
           <div class="contacts-section">
        <div class="contacts-title">üìû Contatti</div>
        <div>
          <span class="contact-item">
            üéÆ Discord: <strong>picciobeffa</strong>
          </span>
          <span class="contact-item">
            üì± Telegram: <strong>@piccionenberg</strong>
          </span>
        </div>
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9rem; color: #a0aec0;">
                     <img src="../../logo.png" alt="Sevcon Logo" style="width: 16px; height: 16px; border-radius: 3px;" onerror="this.style.display='none';">
          ¬© 2025 Sevcon by piccionenberg - Creato con ‚ù§Ô∏è e per noia
        </div>
      </div>
   </div>
 
   <script>
     // Sistema di priorit√† per riparazione equipaggiamento e stelline per pozioni
     const prioritySystem = {
       'Guerriero': {
         'Brim': 1,
         'Carne marcia': 1,
         'Quarzo': 1,
         'Therium': 1,
         'Occhio di ragno': 1,
         'Ametista': 1,
         'Blaze Powder': 1,
         'Membrana': 1,
         'Slime Ball': 1,
         'Prismarine Shard': 1,
         'Lost Soul': 1,
         'Demon Heart': 1,
         'Stagno': 1
       },
       'Ombra': {
         'Brim': 1,
         'Carne marcia': 1,
         'Quarzo': 1,
         'Therium': 1,
         'Occhio di ragno': 1,
         'Ametista': 1,
         'Blaze Powder': 1,
         'Membrana': 1,
         'Slime Ball': 1,
         'Prismarine Shard': 1,
         'Lost Soul': 1,
         'Demon Heart': 1,
         'Stagno': 1
       },
       'Mago': {
         'Brim': 3, // Novizio
         'Carne marcia': 1,
         'Quarzo': 1,
         'Therium': 1,
         'Occhio di ragno': 3, // Avanzato
         'Ametista': 1,
         'Blaze Powder': 1,
         'Membrana': 3, // Esperto
         'Slime Ball': 1,
         'Prismarine Shard': 3, // Custode
         'Lost Soul': 3, // Maestro
         'Demon Heart': 1,
         'Stagno': 1
       },
       'Bardo': {
         'Brim': 1,
         'Carne marcia': 1,
         'Quarzo': 1,
         'Therium': 1,
         'Occhio di ragno': 1,
         'Ametista': 1,
         'Blaze Powder': 1,
         'Membrana': 1,
         'Slime Ball': 1,
         'Prismarine Shard': 1,
         'Lost Soul': 1,
         'Demon Heart': 1,
         'Stagno': 3 // Priorit√† Stagno
       },
       'Cacciatore': {
         'Brim': 1,
         'Carne marcia': 1,
         'Quarzo': 1,
         'Therium': 1,
         'Occhio di ragno': 1,
         'Ametista': 3, // Avanzato
         'Blaze Powder': 1,
         'Membrana': 3, // Esperto
         'Slime Ball': 1,
         'Prismarine Shard': 3, // Custode
         'Lost Soul': 1,
         'Demon Heart': 1,
         'Stagno': 1
       },
       'Raccoglitore': {
         'Brim': 1,
         'Carne marcia': 1,
         'Quarzo': 1,
         'Therium': 1,
         'Occhio di ragno': 3, // Avanzato
         'Ametista': 1,
         'Blaze Powder': 1,
         'Membrana': 3, // Esperto
         'Slime Ball': 1,
         'Prismarine Shard': 3, // Custode
         'Lost Soul': 3, // Maestro
         'Demon Heart': 1,
         'Stagno': 1
       }
     };

     // Sistema stelline per pozioni di cura
     const starSystem = {
       'Brim': 1,
       'Carne marcia': 1,
       'Quarzo': 1,
       'Therium': 1,
       'Occhio di ragno': 1,
       'Ametista': 1,
       'Blaze Powder': 2,
       'Membrana': 2,
       'Slime Ball': 2,
       'Prismarine Shard': 2,
       'Lost Soul': 3,
       'Demon Heart': 3
     };

     const availableClasses = ['Guerriero', 'Ombra', 'Mago', 'Bardo', 'Cacciatore', 'Raccoglitore'];
     const availableTiers = ['Novizio', 'Avanzato', 'Esperto', 'Custode', 'Maestro'];
     let participantClasses = [];
     let participantTiers = [];
     let defaultProducts = [];
     let products = [];
     let divisionMethod = 'simple'; // 'simple' o 'advanced'
     const distributionResults = document.getElementById("distribution-results");
     const participantsInput = document.getElementById("participants");
 
     // Carica i prodotti dal file JSON
     async function loadProducts() {
       const productList = document.getElementById("product-list");
       let jsonLoaded = false;
       
       // Mostra sempre il messaggio di caricamento iniziale
       productList.innerHTML = `
         <div class="loading">
           ‚è≥ Caricamento dati in corso...<br>
           <small>Connessione al database materiali</small>
         </div>
       `;
       
       try {
         console.log('=== DEBUG CARICAMENTO JSON ===');
         console.log('Tentativo di caricamento JSON da:', window.location.href);
         
         // Controlla se √® un problema CORS
         if (window.location.protocol === 'file:') {
           console.log('Rilevato protocollo file:// - problema CORS');
           throw new Error('CORS_BLOCKED');
         }
         
         // Prova a caricare il JSON
         const response = await fetch('./oggetti_abaco.json');
         
         if (!response.ok) {
           throw new Error(`HTTP ${response.status}: ${response.statusText}`);
         }
         
         const data = await response.json();
         console.log('JSON caricato con successo:', data);
         
         defaultProducts = data;
         products = [...defaultProducts.map(p => ({ ...p, qty: 0 }))];
         renderMain();
         updateParticipantClasses();
                   jsonLoaded = true;
         
       } catch (error) {
         console.error('Errore nel caricamento JSON:', error);
         
         if (error.message === 'CORS_BLOCKED') {
           // Mostra messaggio CORS con soluzioni
           productList.innerHTML = `
             <div class="warning">
               <h3>‚ö†Ô∏è Problema di Caricamento</h3>
               <p>Il file JSON non pu√≤ essere caricato direttamente dal browser per motivi di sicurezza.</p>
               <p><strong>Soluzioni:</strong></p>
               <ul style="text-align: left; margin: 10px 0;">
                 <li>Usa un server locale (es. Live Server in VS Code)</li>
                 <li>Carica il file su un server web</li>
                 <li>Oppure clicca il pulsante qui sotto per usare i dati di test</li>
               </ul>
               <button onclick="loadProductsFromFallback()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 10px;">
                 Usa Dati di Test
               </button>
             </div>
           `;
         } else {
           // Mostra errore generico
           productList.innerHTML = `
             <div class="error">
               <h3>‚ùå Errore di Caricamento</h3>
               <p>Impossibile caricare i dati dei materiali: ${error.message}</p>
               <button onclick="loadProductsFromFallback()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 10px;">
                 Usa Dati di Test
               </button>
             </div>
           `;
         }
       }
     }

     function loadProductsFromFallback() {
       console.log('Caricamento dati di fallback...');
       const productList = document.getElementById("product-list");
       
       // Dati di fallback con materiali per pozioni
       defaultProducts = [
         { name: "Brim", price: 50, category: "Reagenti", subcategory: "Novizio", tier: "Novizio" },
         { name: "Carne marcia", price: 75, category: "Reagenti", subcategory: "Novizio", tier: "Novizio" },
         { name: "Quarzo", price: 100, category: "Reagenti", subcategory: "Novizio", tier: "Novizio" },
         { name: "Therium", price: 125, category: "Reagenti", subcategory: "Novizio", tier: "Novizio" },
         { name: "Occhio di ragno", price: 200, category: "Reagenti", subcategory: "Avanzato", tier: "Avanzato" },
         { name: "Ametista", price: 250, category: "Reagenti", subcategory: "Avanzato", tier: "Avanzato" },
         { name: "Blaze Powder", price: 300, category: "Reagenti", subcategory: "Esperto", tier: "Esperto" },
         { name: "Membrana", price: 400, category: "Reagenti", subcategory: "Esperto", tier: "Esperto" },
         { name: "Slime Ball", price: 500, category: "Reagenti", subcategory: "Esperto", tier: "Esperto" },
         { name: "Prismarine Shard", price: 600, category: "Reagenti", subcategory: "Custode", tier: "Custode" },
         { name: "Lost Soul", price: 800, category: "Reagenti", subcategory: "Maestro", tier: "Maestro" },
         { name: "Demon Heart", price: 1000, category: "Reagenti", subcategory: "Maestro", tier: "Maestro" },
         { name: "Stagno", price: 30, category: "Metalli", subcategory: "Base", tier: "Base" }
       ];
          
          products = [...defaultProducts.map(p => ({ ...p, qty: 0 }))];
          renderMain();
       updateParticipantClasses();
          
       // Mostra messaggio di successo
          setTimeout(() => {
            productList.innerHTML = `
           <div class="loading">
             ‚úÖ Dati di test caricati con successo!<br>
             <small>Ricarica la pagina per provare il caricamento JSON</small>
              </div>
            `;
         setTimeout(() => {
           renderMain();
          }, 2000);
       }, 1000);
     }

     function getTierClass(tier) {
       return `tier-${tier.toLowerCase()}`;
     }

     function setDivisionMethod(method) {
       divisionMethod = method;
       
       // Aggiorna i tasti
       document.getElementById('simple-division-btn').classList.toggle('active', method === 'simple');
       document.getElementById('advanced-division-btn').classList.toggle('active', method === 'advanced');
       
       // Mostra/nascondi opzioni avanzate
       const advancedOptions = document.querySelectorAll('.advanced-options');
       advancedOptions.forEach(option => {
         option.classList.toggle('hidden', method === 'simple');
       });
       
       // Mostra/nascondi legende appropriate
       const simpleLegend = document.getElementById('simple-legend');
       const advancedLegend = document.getElementById('advanced-legend');
       
       if (simpleLegend && advancedLegend) {
         simpleLegend.style.display = method === 'simple' ? 'block' : 'none';
         advancedLegend.style.display = method === 'advanced' ? 'block' : 'none';
       }
       
       // Se √® divisione semplice, inizializza con valori di default
       if (method === 'simple') {
         const numParticipants = parseInt(document.getElementById('participants').value);
         participantClasses = new Array(numParticipants).fill('Guerriero');
         participantTiers = new Array(numParticipants).fill('Novizio');
       } else {
         // Se √® avanzata, aggiorna le classi
         updateParticipantClasses();
       }
       
       // Aggiorna la distribuzione
       updateDistribution();
     }

     function updateParticipantClasses() {
       const numParticipants = parseInt(document.getElementById('participants').value);
       const container = document.getElementById('participant-classes');
       const abyssTierSelect = document.getElementById('abyss-tier');
       
       // Inizializza array se necessario
       if (participantClasses.length !== numParticipants) {
         participantClasses = new Array(numParticipants).fill('Guerriero');
         participantTiers = new Array(numParticipants).fill('Novizio');
       }
       
       // Se √® selezionato un tier dell'abisso, imposta tutti i partecipanti a quel tier
       if (abyssTierSelect.value) {
         participantTiers = new Array(numParticipants).fill(abyssTierSelect.value);
       }
       
       let html = '';
       for (let i = 0; i < numParticipants; i++) {
         html += `
           <div class="participant-controls">
             <label class="participant-label">Partecipante ${i + 1}:</label>
             <select class="class-select" data-index="${i}" data-type="class">
               ${availableClasses.map(cls => 
                 `<option value="${cls}" ${participantClasses[i] === cls ? 'selected' : ''}>${cls}</option>`
               ).join('')}
             </select>
             <select class="class-select" data-index="${i}" data-type="tier">
               ${availableTiers.map(tier => 
                 `<option value="${tier}" ${participantTiers[i] === tier ? 'selected' : ''}>${tier}</option>`
               ).join('')}
             </select>
           </div>
         `;
       }
       
       container.innerHTML = html;
       
       // Aggiungi event listeners
       container.querySelectorAll('.class-select').forEach(select => {
         select.addEventListener('change', (e) => {
           const index = parseInt(e.target.dataset.index);
           const type = e.target.dataset.type;
           if (type === 'class') {
             participantClasses[index] = e.target.value;
           } else if (type === 'tier') {
             participantTiers[index] = e.target.value;
           }
           // Non aggiornare automaticamente la distribuzione
         });
       });
     }

     function calculatePriority(item, participantClass) {
       // Usa il nome dell'oggetto per trovare la priorit√†
       return prioritySystem[participantClass]?.[item.name] || 1;
     }

     function getItemStars(item) {
       // Usa il nome dell'oggetto per trovare le stelle per pozioni
       return starSystem[item.name] || 1;
     }

     function findEquivalentItems(targetStars, availableItems) {
       const equivalents = [];
       let currentStars = 0;
       
       // Ordina per priorit√† (pi√π stelle = pi√π priorit√†)
       const sortedItems = availableItems.sort((a, b) => getItemStars(b) - getItemStars(a));
       
       for (const item of sortedItems) {
         if (currentStars + getItemStars(item) <= targetStars) {
           equivalents.push(item);
           currentStars += getItemStars(item);
         }
       }
       
       return equivalents;
     }

     function calculateStarValue(items) {
       return items.reduce((total, item) => total + getItemStars(item), 0);
     }
 
     // Funzione per formattare la valuta (conversione automatica g -> a)
     function formatCurrency(value) {
       if (value >= 100) {
         const argenti = Math.floor(value / 100);
         const bronzini = value % 100;
         
         if (bronzini === 0) {
           return `${argenti}a`;
         } else {
           const bronziniDisplay = (bronzini % 1 === 0) ? bronzini.toString() : bronzini.toFixed(1);
           return `${argenti}a ${bronziniDisplay}g`;
         }
       } else {
         const display = (value % 1 === 0) ? value.toString() : value.toFixed(1);
         return `${display}g`;
       }
     }
 
     // Funzione per applicare la classe CSS corretta in base al valore
     function getCurrencyClass(value) {
       if (value >= 100) {
         return 'currency-mixed';
       } else {
         return 'currency-br';
       }
     }
 
     function renderMain() {
       const productList = document.getElementById("product-list");
       productList.innerHTML = "";
 
       const categories = [...new Set(products.map(p => p.category))];
       
       categories.forEach(category => {
         const categoryDiv = document.createElement("div");
         categoryDiv.className = "category-section";
         
         const categoryTitle = document.createElement("h3");
         categoryTitle.className = "category-title";
         categoryTitle.textContent = category === "Cristalli" ? `Materiali dai ${category}` : category;
         categoryDiv.appendChild(categoryTitle);
 
         if (category === "Cristalli") {
           // Per i cristalli, raggruppa per sottocategorie
           const subcategories = [...new Set(products.filter(p => p.category === category).map(p => p.subcategory))];
           
           subcategories.forEach(subcategory => {
             const subcategoryDiv = document.createElement("div");
             subcategoryDiv.className = "subcategoryDiv";
             subcategoryDiv.style.marginBottom = "20px";
             
             const subcategoryTitle = document.createElement("h4");
             subcategoryTitle.className = "subcategoryTitle";
             subcategoryTitle.textContent = subcategory;
             subcategoryDiv.appendChild(subcategoryTitle);
             
             const subcategoryProducts = products.filter(p => p.category === category && p.subcategory === subcategory);
             
             subcategoryProducts.forEach((p) => {
               const globalIndex = products.indexOf(p);
               const div = createProductElement(p, globalIndex);
               subcategoryDiv.appendChild(div);
             });
             
             categoryDiv.appendChild(subcategoryDiv);
           });
         } else {
           // Per altre categorie, mostra direttamente i prodotti
           const categoryProducts = products.filter(p => p.category === category);
           
           categoryProducts.forEach((p) => {
             const globalIndex = products.indexOf(p);
             const div = createProductElement(p, globalIndex);
             categoryDiv.appendChild(div);
           });
         }
         
         productList.appendChild(categoryDiv);
       });
 
       updateDistribution();
     }
 
     function createProductElement(p, globalIndex) {
       const div = document.createElement("div");
       div.className = "product";
 
       const productInfo = document.createElement("div");
       productInfo.className = "product-info";
       
       const name = document.createElement("div");
       name.className = "product-name";
       name.textContent = p.name;
       
       const tierBadge = document.createElement("span");
       tierBadge.className = `tier-badge ${getTierClass(p.tier)}`;
       tierBadge.textContent = p.tier;
       name.appendChild(tierBadge);
       
       const price = document.createElement("div");
       price.className = `product-price ${getCurrencyClass(p.price)}`;
       price.textContent = formatCurrency(p.price);
       
       productInfo.appendChild(name);
       productInfo.appendChild(price);

       const quantityContainer = document.createElement("div");
       quantityContainer.className = "quantity-container";
       
       const minusBtn = document.createElement("button");
       minusBtn.className = "quantity-btn minus-btn";
       minusBtn.textContent = "-";
       minusBtn.addEventListener("click", () => {
         const currentValue = parseInt(qty.value) || 0;
         if (currentValue > 0) {
           qty.value = currentValue - 1;
           products[globalIndex].qty = currentValue - 1;
           // Non aggiornare automaticamente la distribuzione
         }
       });
 
               const qty = document.createElement("input");
        qty.type = "number";
       qty.className = "quantity-input";
        qty.min = "0";
        qty.value = p.qty > 0 ? p.qty : "";
       qty.placeholder = "0";
       qty.addEventListener("input", () => {
         products[globalIndex].qty = parseInt(qty.value) || 0;
         // Non aggiornare automaticamente la distribuzione
       });
 
       const plusBtn = document.createElement("button");
       plusBtn.className = "quantity-btn plus-btn";
       plusBtn.textContent = "+";
       plusBtn.addEventListener("click", () => {
         const currentValue = parseInt(qty.value) || 0;
         qty.value = currentValue + 1;
         products[globalIndex].qty = currentValue + 1;
         // Non aggiornare automaticamente la distribuzione
       });

       quantityContainer.appendChild(minusBtn);
       quantityContainer.appendChild(qty);
       quantityContainer.appendChild(plusBtn);

       div.appendChild(productInfo);
       div.appendChild(quantityContainer);
       
       return div;
     }
 
     function updateDistribution() {
       // Funzione vuota - ora la divisione viene calcolata solo quando si preme il pulsante
       const container = document.getElementById('distribution-results');
       container.innerHTML = '<div class="empty-state">Inserisci le quantit√† dei materiali e premi "Calcola Divisione"</div>';
     }

     function calculateDistribution() {
       console.log('calculateDistribution called');
       const numParticipants = parseInt(participantsInput.value) || 1;
       const container = document.getElementById('distribution-results');
       const calculateBtn = document.getElementById('calculate-btn');
       
       if (numParticipants <= 0) {
         container.innerHTML = '<div class="empty-state">Inserisci un numero valido di partecipanti</div>';
         return;
       }

       // Disabilita il pulsante durante il calcolo
       calculateBtn.disabled = true;
       calculateBtn.innerHTML = '‚è≥ Calcolando...';

       // Simula un piccolo delay per mostrare il feedback
       setTimeout(() => {
         console.log('Starting item collection...');
         // Raccogli tutti gli oggetti con quantit√† > 0
         const selectedItems = [];
         const quantityInputs = document.querySelectorAll('.quantity-input');
         console.log('Found quantity inputs:', quantityInputs.length);
         
         quantityInputs.forEach((input, index) => {
           const quantity = parseInt(input.value) || 0;
           console.log(`Input ${index}: quantity = ${quantity}`);
           if (quantity > 0) {
             const productNameElement = input.closest('.product').querySelector('.product-name');
             const fullText = productNameElement.textContent;
             const productName = fullText.replace(/\s*(Novizio|Avanzato|Esperto|Custode|Maestro|Tutti|Base)\s*$/, '').trim();
             console.log(`Full text: "${fullText}"`);
             console.log(`Product name: "${productName}"`);
             const product = products.find(p => p.name === productName);
             console.log(`Found product:`, product);
             if (product) {
               for (let i = 0; i < quantity; i++) {
                 selectedItems.push({...product});
               }
             }
           }
         });

         console.log('Total selected items:', selectedItems.length);
         
         if (selectedItems.length === 0) {
           console.log('No items selected, showing empty state');
           container.innerHTML = '<div class="empty-state">Inserisci le quantit√† dei materiali per vedere la divisione</div>';
           calculateBtn.disabled = false;
           calculateBtn.innerHTML = 'üßÆ Calcola Divisione';
           return;
         }

         // Calcola la distribuzione
         console.log('Selected items:', selectedItems);
         console.log('Number of participants:', numParticipants);
         console.log('Calling performDistribution...');
         const distribution = performDistribution(selectedItems, numParticipants);
         console.log('Distribution result:', distribution);
         console.log('Calling renderDistribution...');
         renderDistribution(distribution);
         console.log('renderDistribution completed');
         
         // Riabilita il pulsante
         calculateBtn.disabled = false;
         calculateBtn.innerHTML = '‚úÖ Calcolato!';
         
         // Torna al testo originale dopo 2 secondi
         setTimeout(() => {
           calculateBtn.innerHTML = 'üßÆ Calcola Divisione';
         }, 2000);
       }, 500);
     }

     function performDistribution(items, numParticipants) {
       console.log('performDistribution called with', items.length, 'items and', numParticipants, 'participants');
       const participants = [];
       for (let i = 0; i < numParticipants; i++) {
         participants.push({
           index: i,
           class: participantClasses[i] || 'Guerriero',
           tier: participantTiers[i] || 'Novizio',
           items: [],
           totalValue: 0,
           starValue: 0
         });
       }

       // Se √® divisione semplice, usa solo distribuzione equa
       if (divisionMethod === 'simple') {
         return performSimpleDistribution(items, participants);
       }

       // Fase 1: Distribuzione base (1 oggetto per partecipante)
       const baseItems = [...items];
       let itemIndex = 0;
       
       for (let round = 0; round < Math.floor(baseItems.length / numParticipants); round++) {
         for (let p = 0; p < numParticipants; p++) {
           if (itemIndex < baseItems.length) {
             const item = baseItems[itemIndex++];
             participants[p].items.push(item);
             participants[p].totalValue += item.price;
             participants[p].starValue += getItemStars(item);
           }
         }
       }

       // Fase 2: Distribuzione per priorit√† degli oggetti rimanenti
       const remainingItems = baseItems.slice(itemIndex);
       if (remainingItems.length > 0) {
         // Ordina i partecipanti per priorit√† media
         const sortedParticipants = participants.sort((a, b) => {
           const aAvgPriority = a.items.length > 0 ? 
             a.items.reduce((sum, item) => sum + calculatePriority(item, a.class), 0) / a.items.length : 0;
           const bAvgPriority = b.items.length > 0 ? 
             b.items.reduce((sum, item) => sum + calculatePriority(item, b.class), 0) / b.items.length : 0;
           return bAvgPriority - aAvgPriority;
         });

         for (const item of remainingItems) {
           // Trova il partecipante con la priorit√† pi√π alta per questo oggetto
           let bestParticipant = sortedParticipants[0];
           let bestPriority = calculatePriority(item, bestParticipant.class);
           
           for (const participant of sortedParticipants) {
             const priority = calculatePriority(item, participant.class);
             if (priority > bestPriority) {
               bestPriority = priority;
               bestParticipant = participant;
             }
           }
           
           bestParticipant.items.push(item);
           bestParticipant.totalValue += item.price;
           bestParticipant.starValue += getItemStars(item);
         }
       }

       // Fase 3: Bilanciamento per stelle
       const avgStarValue = participants.reduce((sum, p) => sum + p.starValue, 0) / participants.length;
       const highStarParticipants = participants.filter(p => p.starValue > avgStarValue * 1.2);
       const lowStarParticipants = participants.filter(p => p.starValue < avgStarValue * 0.8);

       for (const highStar of highStarParticipants) {
         const excessStars = highStar.starValue - avgStarValue;
         const itemsToCompensate = highStar.items.filter(item => getItemStars(item) > 1);
         
         for (const lowStar of lowStarParticipants) {
           if (lowStar.starValue < avgStarValue * 0.8) {
             const neededStars = Math.ceil(avgStarValue - lowStar.starValue);
             const compensation = findEquivalentItems(neededStars, itemsToCompensate);
             
             for (const item of compensation) {
               const itemIndex = highStar.items.indexOf(item);
               if (itemIndex > -1) {
                 highStar.items.splice(itemIndex, 1);
                 highStar.totalValue -= item.price;
                 highStar.starValue -= getItemStars(item);
                 
                 lowStar.items.push(item);
                 lowStar.totalValue += item.price;
                 lowStar.starValue += getItemStars(item);
               }
             }
           }
         }
       }

       return participants;
     }

     function performSimpleDistribution(items, participants) {
       console.log('Using simple distribution method (main abaco algorithm)');
       
       // Raggruppa gli oggetti per tipo e quantit√† (come nell'abaco principale)
       const itemGroups = {};
       items.forEach(item => {
         if (!itemGroups[item.name]) {
           itemGroups[item.name] = {
             name: item.name,
             price: item.price,
             qty: 0
           };
         }
         itemGroups[item.name].qty++;
       });
       
       const activeItems = Object.values(itemGroups).filter(item => item.qty > 0);
       const numParticipants = participants.length;
       
       // Array per tenere traccia dei valori di ogni partecipante
       const participantValues = new Array(numParticipants).fill(0);
       const participantItems = new Array(numParticipants).fill().map(() => []);
       
       // Distribuzione base: divide equamente gli oggetti interi
       activeItems.forEach(item => {
         const itemsPerParticipant = Math.floor(item.qty / numParticipants);
         const totalDistributed = itemsPerParticipant * numParticipants;
         
         if (itemsPerParticipant > 0) {
           for (let i = 0; i < numParticipants; i++) {
             participantItems[i].push({
               name: item.name,
               qty: itemsPerParticipant,
               price: item.price
             });
             participantValues[i] += itemsPerParticipant * item.price;
           }
         }
       });
       
       // Calcola l'esubero (oggetti rimanenti)
       const esuberoItems = [];
       activeItems.forEach(item => {
         const itemsPerParticipant = Math.floor(item.qty / numParticipants);
         const totalDistributed = itemsPerParticipant * numParticipants;
         const remaining = item.qty - totalDistributed;
         
         if (remaining > 0) {
           esuberoItems.push({
             name: item.name,
             qty: remaining,
             price: item.price
           });
         }
       });
       
       // Se c'√® esubero, lo distribuisce in modo bilanciato tra i partecipanti
       if (esuberoItems.length > 0) {
         const totalEsuberoValue = esuberoItems.reduce((total, item) => total + (item.qty * item.price), 0);
         
         // Ordina gli oggetti dell'esubero per valore (dal pi√π alto al pi√π basso)
         esuberoItems.sort((a, b) => b.price - a.price);
         
         // Distribuisce gli oggetti in modo bilanciato
         esuberoItems.forEach(item => {
           let remainingQty = item.qty;
           
           // Distribuisce gli oggetti uno per uno, sempre al partecipante con valore pi√π basso
           while (remainingQty > 0) {
             const qtyToGive = Math.min(1, remainingQty);
             
             // Trova il partecipante con il valore pi√π basso
             let minValueIndex = 0;
             let minValue = participantValues[0];
             
             for (let i = 1; i < numParticipants; i++) {
               if (participantValues[i] < minValue) {
                 minValue = participantValues[i];
                 minValueIndex = i;
               }
             }
             
             // Aggiunge l'oggetto al partecipante con valore pi√π basso
             participantItems[minValueIndex].push({
               name: item.name,
               qty: qtyToGive,
               price: item.price,
               isEsubero: true // Marca come oggetto dell'esubero
             });
             
             // Aggiorna il valore del partecipante
             participantValues[minValueIndex] += qtyToGive * item.price;
             
             remainingQty -= qtyToGive;
           }
         });
       }
       
       // Aggiorna i partecipanti con i risultati
       participants.forEach((participant, index) => {
         participant.items = participantItems[index];
         participant.totalValue = participantValues[index];
         participant.starValue = participantItems[index].reduce((sum, item) => sum + getItemStars(item), 0);
       });

       return participants;
     }

     function renderDistribution(participants) {
       console.log('renderDistribution called with:', participants);
       const container = document.getElementById('distribution-results');
       
       if (!container) {
         console.error('Distribution results container not found');
         return;
       }
       
       container.innerHTML = '';
       
       if (!participants || participants.length === 0) {
         container.innerHTML = '<div class="empty-state">Nessun partecipante selezionato</div>';
         return;
       }
       
       // Se √® divisione semplice, usa il formato dell'abaco principale
       if (divisionMethod === 'simple') {
         renderSimpleDistribution(participants, container);
         return;
       }
       
       // Altrimenti usa il formato avanzato con classi e stelle
       renderAdvancedDistribution(participants, container);
     }
     
     function renderSimpleDistribution(participants, container) {
       console.log('Rendering simple distribution like main abaco');
       
       // Raggruppa gli oggetti per tipo per calcolare l'esubero
       const itemGroups = {};
       participants.forEach(participant => {
         participant.items.forEach(item => {
           if (!itemGroups[item.name]) {
             itemGroups[item.name] = {
               name: item.name,
               price: item.price,
               qty: 0,
               esuberoQty: 0
             };
           }
           if (item.isEsubero) {
             itemGroups[item.name].esuberoQty += item.qty;
           } else {
             // Per la distribuzione base, prendi solo la quantit√† di un partecipante (tutti hanno la stessa quantit√†)
             if (itemGroups[item.name].qty === 0) {
               itemGroups[item.name].qty = item.qty;
             }
           }
         });
       });
       
       // Calcola il valore totale dell'esubero
       const totalEsuberoValue = Object.values(itemGroups).reduce((total, item) => {
         return total + (item.esuberoQty * item.price);
       }, 0);
       
       // Mostra il messaggio dell'esubero se presente
       if (totalEsuberoValue > 0) {
         const infoDiv = document.createElement("div");
         infoDiv.style.textAlign = "center";
         infoDiv.style.marginTop = "20px";
         infoDiv.style.padding = "15px";
         infoDiv.style.background = "rgba(99, 179, 237, 0.1)";
         infoDiv.style.borderRadius = "8px";
         infoDiv.style.border = "1px solid rgba(99, 179, 237, 0.3)";
         infoDiv.style.color = "#63b3ed";
         infoDiv.style.fontSize = "0.9rem";
         infoDiv.innerHTML = `üì¶ <strong>Esubero distribuito:</strong> ${formatCurrency(totalEsuberoValue)} distribuito in modo bilanciato tra i partecipanti`;
         container.appendChild(infoDiv);
       }
       
       // Mostra "Ogni partecipante prende"
       const baseDistributionDiv = document.createElement("div");
       baseDistributionDiv.style.marginBottom = "30px";
       baseDistributionDiv.style.padding = "20px";
       baseDistributionDiv.style.background = "rgba(72, 187, 120, 0.1)";
       baseDistributionDiv.style.borderRadius = "12px";
       baseDistributionDiv.style.border = "1px solid rgba(72, 187, 120, 0.3)";
       
       const baseTitle = document.createElement("h3");
       baseTitle.style.color = "#68d391";
       baseTitle.style.fontSize = "1.2rem";
       baseTitle.style.marginBottom = "15px";
       baseTitle.style.textAlign = "center";
       baseTitle.textContent = "üéØ Ogni partecipante prende:";
       baseDistributionDiv.appendChild(baseTitle);
       
       // Mostra gli oggetti base (non esubero)
       Object.values(itemGroups).forEach(item => {
         if (item.qty > 0) {
           const itemDiv = document.createElement("div");
           itemDiv.style.display = "flex";
           itemDiv.style.justifyContent = "space-between";
           itemDiv.style.alignItems = "center";
           itemDiv.style.padding = "8px 12px";
           itemDiv.style.margin = "5px 0";
           itemDiv.style.background = "rgba(255, 255, 255, 0.05)";
           itemDiv.style.borderRadius = "6px";
           
           const itemName = document.createElement("span");
           itemName.textContent = `${item.name} x${item.qty}`;
           itemName.style.color = "#ffffff";
           
           const itemCost = document.createElement("span");
           const cost = item.qty * item.price;
           itemCost.className = getCurrencyClass(cost);
           itemCost.textContent = formatCurrency(cost);
           
           itemDiv.appendChild(itemName);
           itemDiv.appendChild(itemCost);
           baseDistributionDiv.appendChild(itemDiv);
         }
       });
       
       container.appendChild(baseDistributionDiv);
       
       // Mostra i risultati per ogni partecipante (solo esubero e totali)
       participants.forEach((participant, index) => {
         const participantDiv = document.createElement("div");
         participantDiv.className = "participant-result";
         
         const title = document.createElement("div");
         title.className = "participant-title";
         title.textContent = `Partecipante ${index + 1}`;
         participantDiv.appendChild(title);
         
         // Mostra solo gli oggetti dell'esubero per questo partecipante
         const esuberoItems = participant.items.filter(item => item.isEsubero);
         
         if (esuberoItems.length > 0) {
           // Raggruppa gli oggetti dell'esubero per nome
           const groupedEsuberoItems = {};
           esuberoItems.forEach(item => {
             if (!groupedEsuberoItems[item.name]) {
               groupedEsuberoItems[item.name] = {
                 name: item.name,
                 qty: 0,
                 price: item.price
               };
             }
             groupedEsuberoItems[item.name].qty += item.qty;
           });
           
           // Mostra gli oggetti dell'esubero raggruppati
           Object.values(groupedEsuberoItems).forEach(item => {
             const itemDiv = document.createElement("div");
             itemDiv.className = "esubero-item";
             itemDiv.style.display = "flex";
             itemDiv.style.justifyContent = "space-between";
             itemDiv.style.alignItems = "center";
             itemDiv.style.padding = "6px 10px";
             itemDiv.style.margin = "3px 0";
             itemDiv.style.background = "rgba(255, 193, 7, 0.1)";
             itemDiv.style.borderRadius = "4px";
             itemDiv.style.border = "1px solid rgba(255, 193, 7, 0.3)";
             
             const itemName = document.createElement("span");
             itemName.textContent = `${item.name} x${item.qty}`;
             itemName.style.color = "#ffc107";
             
             const itemCost = document.createElement("span");
             const cost = item.qty * item.price;
             itemCost.className = getCurrencyClass(cost);
             itemCost.textContent = formatCurrency(cost);
             
             itemDiv.appendChild(itemName);
             itemDiv.appendChild(itemCost);
             participantDiv.appendChild(itemDiv);
           });
         }
         
         // Mostra il totale
         const totalDiv = document.createElement("div");
         totalDiv.className = "total-cost";
         const formattedTotal = formatCurrency(participant.totalValue);
         totalDiv.innerHTML = `Totale: <span class="${getCurrencyClass(participant.totalValue)}">${formattedTotal}</span>`;
         participantDiv.appendChild(totalDiv);
         
         container.appendChild(participantDiv);
       });
     }
     
     function renderAdvancedDistribution(participants, container) {
       console.log('Rendering advanced distribution with classes and stars');
       
       // Raggruppa i partecipanti per classe
       const classGroups = {};
       participants.forEach(participant => {
         if (!classGroups[participant.class]) {
           classGroups[participant.class] = [];
         }
         classGroups[participant.class].push(participant);
       });
       
       let html = '';
       for (const [className, classParticipants] of Object.entries(classGroups)) {
         // Conta gli oggetti per tipo per questa classe
         const itemCounts = {};
         let totalValue = 0;
         let totalStars = 0;
         
         classParticipants.forEach(participant => {
           participant.items.forEach(item => {
             if (!itemCounts[item.name]) {
               itemCounts[item.name] = 0;
             }
             itemCounts[item.name]++;
             });
           totalValue += participant.totalValue;
           totalStars += participant.starValue;
         });
         
         // Calcola stelline per persona
         const starsPerPerson = classParticipants.length > 0 ? Math.round(totalStars / classParticipants.length) : 0;
         const starsRemainder = totalStars % classParticipants.length;
         
         html += `
           <div class="participant-result">
             <div class="participant-title">
               ${className}${classParticipants.length > 1 ? ` (${classParticipants.length} partecipanti)` : ''}
               ${totalStars > 0 ? `<span style="float: right; font-size: 0.9rem; color: #a0aec0;">‚≠ê ${starsPerPerson}${starsRemainder > 0 ? `+${starsRemainder}` : ''} a testa</span>` : ''}
             </div>
             <div class="item-distribution">
               ${Object.entries(itemCounts).map(([itemName, count]) => `
                 <div class="item-row">
                   <span class="item-name">${itemName} x${count}</span>
                 </div>
               `).join('')}
             </div>
             <div class="total-cost">
               Totale: ${formatCurrency(totalValue)}
             </div>
           </div>
         `;
       }
       
       container.innerHTML = html;
     }
 
         // Funzione per ricaricare i dati manualmente
    async function reloadData() {
      const reloadButton = document.getElementById('reload-data');
      const originalText = reloadButton.innerHTML;
      
      // Mostra che sta caricando
      reloadButton.innerHTML = '‚è≥ Caricando...';
      reloadButton.disabled = true;
      
      try {
        await loadProducts();
        reloadButton.innerHTML = '‚úÖ Ricaricato!';
        
        // Torna al testo originale dopo 2 secondi
        setTimeout(() => {
          reloadButton.innerHTML = originalText;
          reloadButton.disabled = false;
        }, 2000);
      } catch (error) {
        reloadButton.innerHTML = '‚ùå Errore';
        console.error('Errore nel ricaricamento:', error);
        
        // Torna al testo originale dopo 3 secondi
        setTimeout(() => {
          reloadButton.innerHTML = originalText;
          reloadButton.disabled = false;
        }, 3000);
      }
    }

    // Event listeners
    participantsInput.addEventListener("input", () => {
      updateParticipantClasses();
      updateDistribution();
    });

    // Event listener per il tier dell'abisso
    document.addEventListener('DOMContentLoaded', () => {
      const abyssTierSelect = document.getElementById('abyss-tier');
      const abyssTierInfo = document.getElementById('abyss-tier-info');
      if (abyssTierSelect) {
        abyssTierSelect.addEventListener('change', () => {
          updateParticipantClasses();
          // Mostra/nascondi il messaggio informativo
          if (abyssTierInfo) {
            if (abyssTierSelect.value) {
              abyssTierInfo.style.display = 'block';
            } else {
              abyssTierInfo.style.display = 'none';
            }
          }
        });
      }
    });

     // Inizializzazione
     loadProducts();
     
     // Inizializza con divisione semplice
     setDivisionMethod('simple');
    
    // Event listener per il pulsante Calcola (dopo che tutte le funzioni sono definite)
    document.addEventListener('DOMContentLoaded', () => {
      const calculateBtn = document.getElementById('calculate-btn');
      if (calculateBtn) {
        calculateBtn.addEventListener('click', () => {
          console.log('Button clicked, calling calculateDistribution');
          calculateDistribution();
        });
        console.log('Event listener added to calculate button');
      } else {
        console.log('Calculate button not found');
      }
    });
   </script>
 </body>
</html>
