<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abaco - Calcolatore Materiali</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow-x: hidden;
            max-width: 100vw;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .logo {
            max-width: 200px;
            height: auto;
            margin-bottom: 20px;
        }

        .title {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .participants-section {
            margin-bottom: 20px;
        }

        .participant-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .participant-label {
            font-weight: bold;
            color: #333;
            min-width: 100px;
        }

        .class-select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            min-width: 120px;
        }

        .class-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .priority-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .priority-info h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .priority-list {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .priority-list ul {
            margin-left: 20px;
        }

        .priority-list li {
            margin-bottom: 5px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .category-section {
            margin-bottom: 30px;
            overflow: hidden;
        }

        .category-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #333;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .subcategoryDiv {
            margin-bottom: 20px;
            overflow: hidden;
        }

        .subcategoryTitle {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #555;
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .product {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            overflow: hidden;
        }

        .product-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .product-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .product-price {
            color: #666;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tier-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 5px;
        }

        .tier-1 { background: #d4edda; color: #155724; }
        .tier-2 { background: #fff3cd; color: #856404; }
        .tier-3 { background: #f8d7da; color: #721c24; }

        .quantity-container {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .quantity-btn:hover {
            background: #667eea;
            color: white;
        }

        .quantity-btn:active {
            transform: scale(0.95);
        }

        .quantity-input {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            -moz-appearance: textfield;
        }

        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .quantity-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .results-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .participant-result {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            overflow: hidden;
        }

        .participant-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-distribution {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            overflow: hidden;
        }

        .item-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-details {
            font-size: 0.9rem;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .total-cost {
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
            overflow: hidden;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-size: 1.1rem;
            padding: 40px 20px;
            overflow: hidden;
        }

        .error {
            text-align: center;
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow: hidden;
        }

        .warning {
            text-align: center;
            color: #856404;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow: hidden;
        }

        .server-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background 0.2s ease;
        }

        .server-button:hover {
            background: #218838;
        }

        .contacts-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 30px;
            overflow: hidden;
        }

        .contacts-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .contact-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
        }

        .contact-item h4 {
            color: #333;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .contact-item p {
            color: #666;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .homepage-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: transform 0.2s ease;
            overflow: hidden;
        }

        .homepage-link:hover {
            transform: translateY(-2px);
        }

        .fractional-display {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .container {
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .section {
                padding: 20px;
            }
            
            .participant-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .participant-label {
                min-width: auto;
            }
            
            .class-select {
                min-width: auto;
            }
        }

        @media (max-width: 480px) {
            .title {
                font-size: 1.8rem;
            }
            
            .section {
                padding: 15px;
            }
            
            .product {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .product-info {
                text-align: center;
            }
            
            .quantity-container {
                justify-content: center;
            }
        }

        @media (max-width: 360px) {
            .container {
                padding: 10px;
            }
            
            .section {
                padding: 12px;
            }
            
            .quantity-btn {
                width: 25px;
                height: 25px;
                font-size: 14px;
            }
            
            .quantity-input {
                width: 50px;
                font-size: 12px;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .quantity-btn {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }
            
            .quantity-input {
                width: 70px;
                font-size: 16px;
                padding: 8px;
            }
            
            .class-select {
                padding: 12px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="../logo.png" alt="Logo" class="logo">
            <h1 class="title">Abaco</h1>
            <p class="subtitle">Calcolatore Materiali per Divisione Equa</p>
        </div>

        <div class="main-content">
            <div class="section">
                <h2 class="section-title">Configurazione</h2>
                
                <div class="participants-section">
                    <div class="input-group">
                        <label for="participants">Numero di Partecipanti:</label>
                        <input type="number" id="participants" min="1" max="10" value="4">
                    </div>
                    
                    <div id="participant-classes"></div>
                    
                    <div class="priority-info">
                        <h4>Sistema di Priorità per Stelle</h4>
                        <div class="priority-list">
                            <p><strong>Classi disponibili:</strong></p>
                            <ul>
                                <li><strong>Mago:</strong> Priorità alta su materiali magici</li>
                                <li><strong>Guerriero:</strong> Priorità alta su armi e armature</li>
                                <li><strong>Ladro:</strong> Priorità alta su oggetti di precisione</li>
                                <li><strong>Chierico:</strong> Priorità alta su oggetti sacri</li>
                                <li><strong>Ranger:</strong> Priorità alta su oggetti naturali</li>
                                <li><strong>Bardo:</strong> Priorità media su tutti gli oggetti</li>
                            </ul>
                            <p><strong>Sistema Stelle:</strong> Ogni materiale ha un valore in stelle. Se un partecipante riceve materiali di alto valore stellare, gli altri riceveranno l'equivalente in stelle.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Materiali</h2>
                <div id="products-container">
                    <div class="loading">Caricamento materiali...</div>
                </div>
            </div>
        </div>

        <div class="results-section">
            <h2 class="section-title">Risultati Divisione</h2>
            <div id="results-container">
                <div class="empty-state">Inserisci le quantità dei materiali per vedere la divisione</div>
            </div>
        </div>

        <div class="contacts-section">
            <h2 class="contacts-title">Contatti</h2>
            <div class="contact-item">
                <h4>Discord</h4>
                <p>sevc0n#1234</p>
            </div>
            <div class="contact-item">
                <h4>Email</h4>
                <p>sevc0n@example.com</p>
            </div>
            <a href="../index.html" class="homepage-link">← Torna alla Homepage</a>
        </div>
    </div>

    <script>
        // Sistema di priorità e stelle
        const prioritySystem = {
            'Mago': {
                'Magico': 3,
                'Arma': 1,
                'Armatura': 1,
                'Oggetto': 2,
                'Prezioso': 2
            },
            'Guerriero': {
                'Magico': 1,
                'Arma': 3,
                'Armatura': 3,
                'Oggetto': 1,
                'Prezioso': 2
            },
            'Ladro': {
                'Magico': 1,
                'Arma': 2,
                'Armatura': 1,
                'Oggetto': 3,
                'Prezioso': 3
            },
            'Chierico': {
                'Magico': 2,
                'Arma': 1,
                'Armatura': 2,
                'Oggetto': 2,
                'Prezioso': 3
            },
            'Ranger': {
                'Magico': 1,
                'Arma': 2,
                'Armatura': 2,
                'Oggetto': 2,
                'Prezioso': 2
            },
            'Bardo': {
                'Magico': 2,
                'Arma': 2,
                'Armatura': 2,
                'Oggetto': 2,
                'Prezioso': 2
            }
        };

        const starSystem = {
            'Tier 1': 1,
            'Tier 2': 2,
            'Tier 3': 3
        };

        const availableClasses = ['Mago', 'Guerriero', 'Ladro', 'Chierico', 'Ranger', 'Bardo'];
        let participantClasses = [];
        let products = [];

        // Carica i prodotti dal JSON
        async function loadProducts() {
            try {
                console.log('Tentativo di caricamento JSON...');
                const response = await fetch('./oggetti_abaco.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('JSON caricato con successo:', data);
                
                products = data;
                renderProducts();
                updateParticipantClasses();
                
            } catch (error) {
                console.error('Errore nel caricamento JSON:', error);
                
                // Controlla se è un problema CORS
                if (window.location.protocol === 'file:') {
                    showCorsWarning();
                } else {
                    showError('Errore nel caricamento dei materiali: ' + error.message);
                }
            }
        }

        function showCorsWarning() {
            const container = document.getElementById('products-container');
            container.innerHTML = `
                <div class="warning">
                    <h3>⚠️ Problema di Caricamento</h3>
                    <p>Il file JSON non può essere caricato direttamente dal browser per motivi di sicurezza.</p>
                    <p><strong>Soluzioni:</strong></p>
                    <ul style="text-align: left; margin: 10px 0;">
                        <li>Usa un server locale (es. Live Server in VS Code)</li>
                        <li>Carica il file su un server web</li>
                        <li>Oppure clicca il pulsante qui sotto per usare i dati di test</li>
                    </ul>
                    <button class="server-button" onclick="loadProductsFromFallback()">
                        Usa Dati di Test
                    </button>
                </div>
            `;
        }

        function showError(message) {
            const container = document.getElementById('products-container');
            container.innerHTML = `
                <div class="error">
                    <h3>❌ Errore</h3>
                    <p>${message}</p>
                    <button class="server-button" onclick="loadProductsFromFallback()">
                        Usa Dati di Test
                    </button>
                </div>
            `;
        }

        function loadProductsFromFallback() {
            console.log('Caricamento dati di fallback...');
            products = [
                {
                    "nome": "Membrana di Drago",
                    "prezzo": 5000,
                    "categoria": "Magico",
                    "sottocategoria": "Componenti",
                    "tier": "Tier 3"
                },
                {
                    "nome": "Spada del Drago",
                    "prezzo": 3000,
                    "categoria": "Arma",
                    "sottocategoria": "Spade",
                    "tier": "Tier 2"
                },
                {
                    "nome": "Armatura di Drago",
                    "prezzo": 4000,
                    "categoria": "Armatura",
                    "sottocategoria": "Armature",
                    "tier": "Tier 2"
                },
                {
                    "nome": "Pozione di Guarigione",
                    "prezzo": 50,
                    "categoria": "Magico",
                    "sottocategoria": "Pozioni",
                    "tier": "Tier 1"
                },
                {
                    "nome": "Daga Affilata",
                    "prezzo": 200,
                    "categoria": "Arma",
                    "sottocategoria": "Daghe",
                    "tier": "Tier 1"
                },
                {
                    "nome": "Scudo di Legno",
                    "prezzo": 100,
                    "categoria": "Armatura",
                    "sottocategoria": "Scudi",
                    "tier": "Tier 1"
                },
                {
                    "nome": "Anello Magico",
                    "prezzo": 1000,
                    "categoria": "Oggetto",
                    "sottocategoria": "Anelli",
                    "tier": "Tier 2"
                },
                {
                    "nome": "Gemma Preziosa",
                    "prezzo": 800,
                    "categoria": "Prezioso",
                    "sottocategoria": "Gemme",
                    "tier": "Tier 2"
                }
            ];
            
            renderProducts();
            updateParticipantClasses();
            
            const container = document.getElementById('products-container');
            container.innerHTML = '<div class="loading">Dati di test caricati. Ricarica la pagina per provare il caricamento JSON.</div>';
            setTimeout(() => {
                renderProducts();
            }, 1000);
        }

        function renderProducts() {
            const container = document.getElementById('products-container');
            
            if (!products || products.length === 0) {
                container.innerHTML = '<div class="empty-state">Nessun materiale disponibile</div>';
                return;
            }

            // Raggruppa per categoria e sottocategoria
            const grouped = products.reduce((acc, product) => {
                if (!acc[product.categoria]) {
                    acc[product.categoria] = {};
                }
                if (!acc[product.categoria][product.sottocategoria]) {
                    acc[product.categoria][product.sottocategoria] = [];
                }
                acc[product.categoria][product.sottocategoria].push(product);
                return acc;
            }, {});

            let html = '';
            for (const [categoria, sottocategorie] of Object.entries(grouped)) {
                html += `<div class="category-section">
                    <h3 class="category-title">${categoria}</h3>`;
                
                for (const [sottocategoria, items] of Object.entries(sottocategorie)) {
                    html += `<div class="subcategoryDiv">
                        <h4 class="subcategoryTitle">${sottocategoria}</h4>`;
                    
                    for (const item of items) {
                        html += createProductElement(item);
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function createProductElement(product) {
            const tierClass = product.tier.toLowerCase().replace(' ', '-');
            return `
                <div class="product" data-name="${product.nome}">
                    <div class="product-info">
                        <div class="product-name">
                            ${product.nome}
                            <span class="tier-badge ${tierClass}">${product.tier}</span>
                        </div>
                        <div class="product-price">${formatCurrency(product.prezzo)}</div>
                    </div>
                    <div class="quantity-container">
                        <button class="quantity-btn minus-btn" data-name="${product.nome}">-</button>
                        <input type="number" class="quantity-input" data-name="${product.nome}" min="0" value="0">
                        <button class="quantity-btn plus-btn" data-name="${product.nome}">+</button>
                    </div>
                </div>
            `;
        }

        function updateParticipantClasses() {
            const numParticipants = parseInt(document.getElementById('participants').value);
            const container = document.getElementById('participant-classes');
            
            // Inizializza array se necessario
            if (participantClasses.length !== numParticipants) {
                participantClasses = new Array(numParticipants).fill('Mago');
            }
            
            let html = '';
            for (let i = 0; i < numParticipants; i++) {
                html += `
                    <div class="participant-controls">
                        <label class="participant-label">Partecipante ${i + 1}:</label>
                        <select class="class-select" data-index="${i}">
                            ${availableClasses.map(cls => 
                                `<option value="${cls}" ${participantClasses[i] === cls ? 'selected' : ''}>${cls}</option>`
                            ).join('')}
                        </select>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Aggiungi event listeners
            container.querySelectorAll('.class-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    participantClasses[index] = e.target.value;
                    updateDistribution();
                });
            });
        }

        function calculatePriority(item, participantClass) {
            const basePriority = prioritySystem[participantClass]?.[item.categoria] || 1;
            const tierMultiplier = starSystem[item.tier] || 1;
            return basePriority * tierMultiplier;
        }

        function getItemStars(item) {
            return starSystem[item.tier] || 1;
        }

        function findEquivalentItems(targetStars, availableItems) {
            const equivalents = [];
            let currentStars = 0;
            
            // Ordina per priorità (più stelle = più priorità)
            const sortedItems = availableItems.sort((a, b) => getItemStars(b) - getItemStars(a));
            
            for (const item of sortedItems) {
                if (currentStars + getItemStars(item) <= targetStars) {
                    equivalents.push(item);
                    currentStars += getItemStars(item);
                }
            }
            
            return equivalents;
        }

        function calculateStarValue(items) {
            return items.reduce((total, item) => total + getItemStars(item), 0);
        }

        function updateDistribution() {
            const numParticipants = parseInt(document.getElementById('participants').value);
            const container = document.getElementById('results-container');
            
            if (numParticipants <= 0) {
                container.innerHTML = '<div class="empty-state">Inserisci un numero valido di partecipanti</div>';
                return;
            }

            // Raccogli tutti gli oggetti con quantità > 0
            const selectedItems = [];
            document.querySelectorAll('.quantity-input').forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    const productName = input.dataset.name;
                    const product = products.find(p => p.nome === productName);
                    if (product) {
                        for (let i = 0; i < quantity; i++) {
                            selectedItems.push({...product});
                        }
                    }
                }
            });

            if (selectedItems.length === 0) {
                container.innerHTML = '<div class="empty-state">Inserisci le quantità dei materiali per vedere la divisione</div>';
                return;
            }

            // Calcola la distribuzione
            const distribution = calculateDistribution(selectedItems, numParticipants);
            renderDistribution(distribution);
        }

        function calculateDistribution(items, numParticipants) {
            const participants = [];
            for (let i = 0; i < numParticipants; i++) {
                participants.push({
                    index: i,
                    class: participantClasses[i] || 'Mago',
                    items: [],
                    totalValue: 0,
                    starValue: 0
                });
            }

            // Fase 1: Distribuzione base (1 oggetto per partecipante)
            const baseItems = [...items];
            let itemIndex = 0;
            
            for (let round = 0; round < Math.floor(baseItems.length / numParticipants); round++) {
                for (let p = 0; p < numParticipants; p++) {
                    if (itemIndex < baseItems.length) {
                        const item = baseItems[itemIndex++];
                        participants[p].items.push(item);
                        participants[p].totalValue += item.prezzo;
                        participants[p].starValue += getItemStars(item);
                    }
                }
            }

            // Fase 2: Distribuzione per priorità degli oggetti rimanenti
            const remainingItems = baseItems.slice(itemIndex);
            if (remainingItems.length > 0) {
                // Ordina i partecipanti per priorità media
                const sortedParticipants = participants.sort((a, b) => {
                    const aAvgPriority = a.items.length > 0 ? 
                        a.items.reduce((sum, item) => sum + calculatePriority(item, a.class), 0) / a.items.length : 0;
                    const bAvgPriority = b.items.length > 0 ? 
                        b.items.reduce((sum, item) => sum + calculatePriority(item, b.class), 0) / b.items.length : 0;
                    return bAvgPriority - aAvgPriority;
                });

                for (const item of remainingItems) {
                    // Trova il partecipante con la priorità più alta per questo oggetto
                    let bestParticipant = sortedParticipants[0];
                    let bestPriority = calculatePriority(item, bestParticipant.class);
                    
                    for (const participant of sortedParticipants) {
                        const priority = calculatePriority(item, participant.class);
                        if (priority > bestPriority) {
                            bestPriority = priority;
                            bestParticipant = participant;
                        }
                    }
                    
                    bestParticipant.items.push(item);
                    bestParticipant.totalValue += item.prezzo;
                    bestParticipant.starValue += getItemStars(item);
                }
            }

            // Fase 3: Bilanciamento per stelle
            const avgStarValue = participants.reduce((sum, p) => sum + p.starValue, 0) / participants.length;
            const highStarParticipants = participants.filter(p => p.starValue > avgStarValue * 1.2);
            const lowStarParticipants = participants.filter(p => p.starValue < avgStarValue * 0.8);

            for (const highStar of highStarParticipants) {
                const excessStars = highStar.starValue - avgStarValue;
                const itemsToCompensate = highStar.items.filter(item => getItemStars(item) > 1);
                
                for (const lowStar of lowStarParticipants) {
                    if (lowStar.starValue < avgStarValue * 0.8) {
                        const neededStars = Math.ceil(avgStarValue - lowStar.starValue);
                        const compensation = findEquivalentItems(neededStars, itemsToCompensate);
                        
                        for (const item of compensation) {
                            const itemIndex = highStar.items.indexOf(item);
                            if (itemIndex > -1) {
                                highStar.items.splice(itemIndex, 1);
                                highStar.totalValue -= item.prezzo;
                                highStar.starValue -= getItemStars(item);
                                
                                lowStar.items.push(item);
                                lowStar.totalValue += item.prezzo;
                                lowStar.starValue += getItemStars(item);
                            }
                        }
                    }
                }
            }

            return participants;
        }

        function renderDistribution(participants) {
            const container = document.getElementById('results-container');
            
            let html = '';
            for (const participant of participants) {
                html += `
                    <div class="participant-result">
                        <div class="participant-title">
                            Partecipante ${participant.index + 1} (${participant.class})
                            <span style="float: right; font-size: 0.9rem; color: #666;">
                                Stelle: ${participant.starValue}
                            </span>
                        </div>
                `;
                
                if (participant.items.length === 0) {
                    html += '<div class="empty-state">Nessun oggetto assegnato</div>';
                } else {
                    for (const item of participant.items) {
                        html += `
                            <div class="item-distribution">
                                <div class="item-name">${item.nome}</div>
                                <div class="item-details">
                                    ${formatCurrency(item.prezzo)} • ${item.categoria} • ${item.tier}
                                </div>
                            </div>
                        `;
                    }
                }
                
                html += `
                        <div class="total-cost">
                            Totale: ${formatCurrency(participant.totalValue)}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            
            document.getElementById('participants').addEventListener('input', () => {
                updateParticipantClasses();
                updateDistribution();
            });
            
            // Event delegation per i bottoni e input
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('minus-btn')) {
                    const input = e.target.nextElementSibling;
                    const currentValue = parseInt(input.value) || 0;
                    if (currentValue > 0) {
                        input.value = currentValue - 1;
                        updateDistribution();
                    }
                } else if (e.target.classList.contains('plus-btn')) {
                    const input = e.target.previousElementSibling;
                    const currentValue = parseInt(input.value) || 0;
                    input.value = currentValue + 1;
                    updateDistribution();
                }
            });
            
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('quantity-input')) {
                    updateDistribution();
                }
            });
        });
    </script>
</body>
</html>
